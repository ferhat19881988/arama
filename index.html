<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Öğrenci-Öğretmen Atama ve Arama Raporu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: Arial, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #222;
      background: #f3f5f7;
    }
    body {
      margin: 0;
      padding: 0 16px 40px;
      background: #f3f5f7;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 8px;
    }
    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 16px 18px;
      margin-top: 16px;
    }
    .flex {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .col {
      flex: 1 1 320px;
      min-width: 280px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    select, input[type="date"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #cbd2dd;
      font-size: 0.9rem;
    }
    select[multiple] {
      height: 160px;
    }
    button {
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
      font-weight: 500;
    }
    button.danger {
      background: #dc2626;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .pill-group button {
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
    }
    thead {
      background: #f9fafb;
    }
    tr:nth-child(even) td {
      background: #f9fafb;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5f0ff;
      color: #1d4ed8;
      margin-left: 4px;
    }
    .muted {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .date-preview {
      font-size: 0.8rem;
      margin-top: 4px;
      color: #374151;
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .report-card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 12px;
      page-break-inside: avoid;
    }
    .report-card h3 {
      margin-top: 0;
      margin-bottom: 4px;
    }
    .report-meta {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 6px;
    }
    textarea.note-cell {
      width: 100%;
      min-height: 48px;
      resize: vertical;
      font-size: 0.8rem;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 0.75rem;
      margin-right: 6px;
      margin-top: 2px;
    }
    .chip span {
      font-weight: 600;
      margin-right: 4px;
    }
    .info-block {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 6px;
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
      }
      .no-print {
        display: none !important;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
        margin-top: 0;
      }
      .report-card {
        border: 1px solid #000;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <h1>Öğrenci – Öğretmen Atama ve Arama Takip Sistemi</h1>
  <p style="text-align:center" class="muted">
    Veriler Google Sheets'ten çekilir, atamalar Firebase Realtime Database'e kaydedilir.
  </p>

  <!-- VERİ YÜKLEME -->
  <div class="card no-print">
    <div class="flex-between">
      <div>
        <div class="section-title">1. Google Sheets verilerini yükle</div>
        <div class="muted">
          Öğrenci ve öğretmen listeleri otomatik çekilir. İstersen “Verileri Yeniden Yükle” diyerek yenileyebilirsin.
        </div>
      </div>
      <div>
        <button id="reloadDataBtn">Verileri Yeniden Yükle</button>
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <div class="col">
        <div><strong>Öğrenci Listesi:</strong> <span id="studentStatus" class="muted">Henüz yüklenmedi</span></div>
      </div>
      <div class="col">
        <div><strong>Öğretmen Listesi:</strong> <span id="teacherStatus" class="muted">Henüz yüklenmedi</span></div>
      </div>
    </div>
  </div>

  <!-- ATAMA BÖLÜMÜ -->
  <div class="card no-print">
    <div class="section-title">2. Atama ayarları</div>
    <div class="flex">
      <div class="col">
        <label for="classFilter">Sınıf Seç</label>
        <select id="classFilter"></select>
        <div class="info-block">
          Sınıf seçince aşağıda o sınıfa ait öğrenciler listelenir. İstersen tek tek, istersen tüm sınıfı seçip atama yapabilirsin.
        </div>
      </div>
      <div class="col">
        <label for="teacherSelect">Öğretmen(ler) Seç <span class="badge">Çoklu seçim</span></label>
        <select id="teacherSelect" multiple></select>
        <div class="info-block">
          CTRL / CMD ile birden fazla öğretmen seçebilirsin. Bir sınıfa ve bir öğrenciye istediğin kadar öğretmen atanabilir.
        </div>
      </div>
      <div class="col">
        <label>Tarih Aralığı</label>
        <div class="flex" style="gap:8px">
          <div class="col">
            <input type="date" id="assignStart" />
          </div>
          <div class="col">
            <input type="date" id="assignEnd" />
          </div>
        </div>
        <div class="pill-group" style="margin-top:6px">
          <button type="button" class="secondary" data-quick="7">+ 7 gün</button>
          <button type="button" class="secondary" data-quick="14">+ 14 gün</button>
          <button type="button" class="secondary" data-quick="28">+ 28 gün</button>
        </div>
        <div id="assignDatePreview" class="date-preview">Seçili aralık: henüz seçilmedi</div>
      </div>
    </div>

    <div class="flex-between" style="margin-top:14px">
      <div>
        <button id="selectAllStudentsBtn" class="secondary">Tüm Sınıfı Seç</button>
        <button id="clearSelectionBtn" class="secondary">Seçimleri Temizle</button>
      </div>
      <div>
        <button id="assignBtn">Seçili Öğrencilere Seçili Öğretmenleri Ata</button>
      </div>
    </div>

    <h3 style="margin-top:18px">Sınıf Öğrenci Listesi</h3>
    <div class="muted">Listeden öğrenci seç. “Tüm Sınıfı Seç” butonu ile komple sınıfa da atama yapabilirsin.</div>
    <div style="max-height:260px; overflow:auto; margin-top:6px;">
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="allRowCheckbox" /></th>
            <th>İsim</th>
            <th>Soyisim</th>
            <th>Cinsiyet</th>
            <th>Sınıf</th>
            <th>Okul Numarası</th>
            <th>Veli Adı</th>
            <th>Veli Soyadı</th>
            <th>Veli Telefon</th>
          </tr>
        </thead>
        <tbody id="studentsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ATAMA ÖZETİ + FIREBASE -->
  <div class="card no-print">
    <div class="flex-between">
      <div>
        <div class="section-title">3. Yapılan atamalar</div>
        <div class="muted">Burada sınıf / öğrenci / öğretmen bazında oluşan tüm atamaları görebilirsin.</div>
      </div>
      <div>
        <button id="saveAssignmentsBtn">Atamaları Firebase'e Kaydet</button>
        <button id="deleteAssignmentsBtn" class="danger">Tüm Atamaları Sil</button>
      </div>
    </div>

    <div style="max-height:260px; overflow:auto; margin-top:8px;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Öğretmen</th>
            <th>Branş</th>
            <th>İsim</th>
            <th>Soyisim</th>
            <th>Sınıf</th>
            <th>Okul Numarası</th>
            <th>Veli Adı</th>
            <th>Veli Soyadı</th>
            <th>Veli Telefon</th>
            <th>Tarih Aralığı</th>
            <th>Sil</th>
          </tr>
        </thead>
        <tbody id="assignmentsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- RAPORLAR -->
  <div class="card">
    <div class="flex-between no-print">
      <div>
        <div class="section-title">4. Öğretmen bazlı arama raporları</div>
        <div class="muted">
          Belirlediğin tarihler arasında, her öğretmenin arayacağı öğrenciler listelenir. “Arama yapıldı mı?” ve “Not” alanları
          doldurulup tekrar Firebase'e kaydedilebilir. Yazdır butonu ile profesyonel bir liste alınabilir.
        </div>
      </div>
      <div class="flex" style="gap:8px">
        <div class="col">
          <label>Rapor Tarih Aralığı</label>
          <div class="flex" style="gap:8px">
            <div class="col">
              <input type="date" id="reportStart" />
            </div>
            <div class="col">
              <input type="date" id="reportEnd" />
            </div>
          </div>
        </div>
        <div class="col" style="align-self:flex-end;">
          <button id="generateReportsBtn" class="secondary">Raporları Oluştur</button>
        </div>
      </div>
    </div>

    <div id="reportContainer" style="margin-top:12px;"></div>

    <div class="flex-between no-print" style="margin-top:16px;">
      <div class="muted">
        Not ve arama durumlarını kaydedip daha sonra tekrar açtığında aynı şekilde görebilirsin.
      </div>
      <div>
        <button id="saveReportNotesBtn" class="secondary">Rapor Notlarını Firebase'e Kaydet</button>
        <button id="printReportsBtn">Raporları Yazdır</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  /* SABİTLER */
  const STUDENT_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi/gviz/tq?tqx=out:csv&sheet=2025-2026";
  const TEACHER_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg/export?format=csv&gid=0";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
    authDomain: "odevfeno.firebaseapp.com",
    databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "odevfeno",
    storageBucket: "odevfeno.firebasestorage.app",
    messagingSenderId: "662757516934",
    appId: "1:662757516934:web:0042188832f63deb6fd307",
    measurementId: "G-4Q99NQRB38"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const ASSIGNMENTS_PATH = "assignments";

  let students = [];
  let teachers = [];
  let assignments = [];

  /* YARDIMCI FONKSİYONLAR */

  function detectSeparator(line) {
    const comma = (line.match(/,/g) || []).length;
    const semi = (line.match(/;/g) || []).length;
    return semi > comma ? ";" : ",";
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];
    const sep = detectSeparator(lines[0]);
    const rows = [];
    for (const line of lines) {
      const row = [];
      let cur = "";
      let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i + 1] === '"') {
            cur += '"'; i++;
          } else inQ = !inQ;
        } else if (ch === sep && !inQ) {
          row.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      row.push(cur);
      rows.push(row.map(c => c.trim()));
    }
    return rows;
  }

  function normalizeHeader(str) {
    if (!str) return "";
    return str.replace(/^\uFEFF/, "").replace(/\*/g, "").trim().toLowerCase();
  }

 // Başlığı bire bir, Türkçe karakterlere dokunmadan arar
function findColumnIndex(headerRow, expectedHeader) {
  const target = expectedHeader.replace(/\*/g, "").trim();  // * işaretini kaldır

  for (let i = 0; i < headerRow.length; i++) {
    const cell = (headerRow[i] || "").replace(/\*/g, "").trim();
    if (cell === target) {
      return i;
    }
  }
  return -1;
}



  function toDisplayDateFromISO(iso) {
    if (!iso) return "";
    const [y, m, d] = iso.split("-");
    return `${d}.${m}.${y}`;
  }

  function formatDateForStore(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function dateRangesOverlap(aStart, aEnd, bStart, bEnd) {
    if (!aStart || !aEnd || !bStart || !bEnd) return true;
    return aStart <= bEnd && aEnd >= bStart;
  }

  const unique = arr => Array.from(new Set(arr));
  const uid = () => "a_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  const setText = (id, t) => { const el = document.getElementById(id); if (el) el.textContent = t; };

  /* VERİ ÇEKME */

  async function loadStudents() {
    setText("studentStatus", "Yükleniyor...");
    const res = await fetch(STUDENT_SHEET_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) { setText("studentStatus","Hiç satır yok"); return; }

    const header = rows[0];
const idxIsim      = findColumnIndex(header, "İsim");
const idxSoyisim   = findColumnIndex(header, "Soyisim*");
const idxCinsiyet  = findColumnIndex(header, "Cinsiyet*");
const idxSinif     = findColumnIndex(header, "Sınıf");
const idxOkulNo    = findColumnIndex(header, "Okul Numarası");
const idxVeliAdi   = findColumnIndex(header, "Veli Adı");
const idxVeliSoyad = findColumnIndex(header, "Veli Soyadı");
const idxVeliTel   = findColumnIndex(header, "Veli Telefon");


    // YIL, Tarih, Burslu mu? var ama kullanılmıyor; bulmaya bile gerek yok.

    const required = [idxIsim, idxSoyisim, idxCinsiyet, idxSinif, idxOkulNo];
    if (required.some(i => i === -1)) {
      console.error("Başlıklar:", header);
      setText("studentStatus","Başlıklar bulunamadı (İsim, Soyisim*, Cinsiyet*, Sınıf, Okul Numarası…) kontrol et.");
      return;
    }

    students = rows.slice(1)
      .filter(r => r[idxIsim] && r[idxSinif])
      .map(r => ({
        isim: r[idxIsim] || "",
        soyisim: r[idxSoyisim] || "",
        cinsiyet: r[idxCinsiyet] || "",
        sinif: r[idxSinif] || "",
        okulNo: r[idxOkulNo] || "",
        veliAdi:   idxVeliAdi   !== -1 ? (r[idxVeliAdi]   || "") : "",
        veliSoyadi:idxVeliSoyad !== -1 ? (r[idxVeliSoyad] || "") : "",
        veliTel:   idxVeliTel   !== -1 ? (r[idxVeliTel]   || "") : ""
      }));

    setText("studentStatus", `Yüklendi (${students.length} öğrenci)`);
    fillClassFilter();
    renderStudentsTable();
  }

  async function loadTeachers() {
    setText("teacherStatus", "Yükleniyor...");
    const res = await fetch(TEACHER_SHEET_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) { setText("teacherStatus","Hiç satır yok"); return; }
    const header = rows[0];
    const idxId    = findColumnIndex(header, "id");
    const idxAd    = findColumnIndex(header, "ogretmen_adi");
    const idxBrans = findColumnIndex(header, "brans");

    teachers = rows.slice(1)
      .filter(r => r[idxAd])
      .map(r => ({
        id:    idxId    !== -1 ? (r[idxId]    || "") : "",
        ad:    idxAd    !== -1 ? (r[idxAd]    || "") : "",
        brans: idxBrans !== -1 ? (r[idxBrans] || "") : ""
      }));

    setText("teacherStatus", `Yüklendi (${teachers.length} öğretmen)`);
    fillTeacherSelect();
  }

  async function loadAssignmentsFromFirebase() {
    try {
      const snap = await get(ref(db, ASSIGNMENTS_PATH));
      if (snap.exists()) {
        const val = snap.val();
        assignments = Array.isArray(val) ? val.filter(Boolean) : Object.values(val || {});
      } else assignments = [];
      renderAssignmentsTable();
    } catch (e) { console.error(e); }
  }

  async function loadAllData() {
    try {
      await Promise.all([loadStudents(), loadTeachers(), loadAssignmentsFromFirebase()]);
    } catch (e) {
      console.error(e);
      alert("Veriler yüklenirken hata oluştu (paylaşım izinlerini kontrol et).");
      setText("studentStatus","Hata");
      setText("teacherStatus","Hata");
    }
  }

  /* EKRAN DOLDURMA */

  function fillClassFilter() {
    const sel = document.getElementById("classFilter");
    const siniflar = unique(students.map(s => s.sinif)).sort();
    sel.innerHTML = "";
    siniflar.forEach(s => {
      const o = document.createElement("option");
      o.value = s; o.textContent = s;
      sel.appendChild(o);
    });
  }

  function fillTeacherSelect() {
    const sel = document.getElementById("teacherSelect");
    sel.innerHTML = "";
    teachers.forEach(t => {
      const o = document.createElement("option");
      o.value = t.id;
      o.textContent = `${t.ad} (${t.brans})`;
      sel.appendChild(o);
    });
  }

  function renderStudentsTable() {
    const tbody = document.getElementById("studentsBody");
    const sel = document.getElementById("classFilter");
    if (!sel.value) { tbody.innerHTML=""; return; }
    const sinif = sel.value;
    const list = students.filter(s => s.sinif === sinif);
    tbody.innerHTML = "";
    list.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="student-checkbox" data-okulno="${s.okulNo}"></td>
        <td>${s.isim}</td>
        <td>${s.soyisim}</td>
        <td>${s.cinsiyet}</td>
        <td>${s.sinif}</td>
        <td>${s.okulNo}</td>
        <td>${s.veliAdi}</td>
        <td>${s.veliSoyadi}</td>
        <td>${s.veliTel}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderAssignmentsTable() {
    const tbody = document.getElementById("assignmentsBody");
    tbody.innerHTML = "";
    assignments.forEach((a,i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${a.teacherName}</td>
        <td>${a.teacherBranch}</td>
        <td>${a.studentFirstName}</td>
        <td>${a.studentLastName}</td>
        <td>${a.class}</td>
        <td>${a.schoolNumber}</td>
        <td>${a.parentFirstName}</td>
        <td>${a.parentLastName}</td>
        <td>${a.parentPhone}</td>
        <td>${toDisplayDateFromISO(a.startDate)} – ${toDisplayDateFromISO(a.endDate)}</td>
        <td><button type="button" class="secondary" data-del-id="${a.id}">Sil</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderReports() {
    const cont = document.getElementById("reportContainer");
    cont.innerHTML = "";
    if (!assignments.length) { cont.innerHTML="<p class='muted'>Herhangi bir atama yok.</p>"; return; }

    const rs = document.getElementById("reportStart").value || null;
    const re = document.getElementById("reportEnd").value || null;
    const filtered = assignments.filter(a => dateRangesOverlap(a.startDate,a.endDate,rs,re));
    if (!filtered.length) { cont.innerHTML="<p class='muted'>Seçili aralıkta atama yok.</p>"; return; }

    const groups = {};
    filtered.forEach(a => {
      if (!groups[a.teacherId]) groups[a.teacherId]=[];
      groups[a.teacherId].push(a);
    });

    Object.keys(groups).forEach(tid => {
      const list = groups[tid];
      const tName = list[0].teacherName;
      const tBranch = list[0].teacherBranch;
      const minStart = list.reduce((m,a)=>!m||a.startDate<m?a.startDate:m,null);
      const maxEnd   = list.reduce((m,a)=>!m||a.endDate>m?a.endDate:m,null);

      const card = document.createElement("div");
      card.className="report-card";
      card.innerHTML = `
        <h3>${tName}</h3>
        <div class="report-meta">
          <span class="chip"><span>Branş:</span>${tBranch}</span>
          <span class="chip"><span>Atama Sayısı:</span>${list.length}</span>
          <span class="chip"><span>Tarih:</span>${toDisplayDateFromISO(minStart)} – ${toDisplayDateFromISO(maxEnd)}</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>İsim</th>
              <th>Soyisim</th>
              <th>Cinsiyet</th>
              <th>Sınıf</th>
              <th>Okul No</th>
              <th>Veli Adı</th>
              <th>Veli Soyadı</th>
              <th>Veli Telefon</th>
              <th>Arama yapıldı mı?</th>
              <th>Not</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;
      const tbody = card.querySelector("tbody");
      list.forEach((a,i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${a.studentFirstName}</td>
          <td>${a.studentLastName}</td>
          <td>${a.gender}</td>
          <td>${a.class}</td>
          <td>${a.schoolNumber}</td>
          <td>${a.parentFirstName}</td>
          <td>${a.parentLastName}</td>
          <td>${a.parentPhone}</td>
          <td style="text-align:center;">
            <input type="checkbox" class="report-called" data-assignment-id="${a.id}" ${a.called?"checked":""}>
          </td>
          <td><textarea class="note-cell" data-assignment-id="${a.id}">${a.note||""}</textarea></td>
        `;
        tbody.appendChild(tr);
      });
      cont.appendChild(card);
    });
  }

  /* FIREBASE */

  async function saveAssignmentsToFirebase() {
    try {
      await set(ref(db, ASSIGNMENTS_PATH), assignments);
      alert("Atamalar kaydedildi.");
    } catch (e) {
      console.error(e);
      alert("Firebase'e kaydedilirken hata oluştu.");
    }
  }

  async function deleteAllAssignmentsInFirebase() {
    if (!confirm("Tüm atamaları silmek istiyor musun?")) return;
    try {
      await remove(ref(db, ASSIGNMENTS_PATH));
      assignments = [];
      renderAssignmentsTable();
      document.getElementById("reportContainer").innerHTML="";
      alert("Tüm atamalar silindi.");
    } catch (e) {
      console.error(e);
      alert("Silme sırasında hata oluştu.");
    }
  }

  /* ATAMA OLUŞTURMA & NOT SENKRON */

  const getSelectedTeacherIds = () =>
    Array.from(document.getElementById("teacherSelect").selectedOptions).map(o => o.value);

  function getSelectedStudents() {
    const okulNos = Array.from(document.querySelectorAll(".student-checkbox:checked"))
      .map(cb => cb.getAttribute("data-okulno"));
    return students.filter(s => okulNos.includes(s.okulNo));
  }

  function updateAssignDatePreview() {
    const s = document.getElementById("assignStart").value;
    const e = document.getElementById("assignEnd").value;
    const el = document.getElementById("assignDatePreview");
    if (!s || !e) { el.textContent="Seçili aralık: henüz seçilmedi"; return; }
    el.textContent = "Seçili aralık: " + toDisplayDateFromISO(s) + " – " + toDisplayDateFromISO(e);
  }

  function applyQuickRange(days) {
    const sInput = document.getElementById("assignStart");
    const eInput = document.getElementById("assignEnd");
    let s = sInput.value;
    if (!s) { const t=new Date(); s=formatDateForStore(t); sInput.value=s; }
    const [y,m,d]=s.split("-");
    const base = new Date(+y,+m-1,+d);
    const end  = new Date(base.getTime());
    end.setDate(end.getDate()+Number(days));
    eInput.value = formatDateForStore(end);
    updateAssignDatePreview();
  }

  function createAssignments() {
    const tids = getSelectedTeacherIds();
    const studs = getSelectedStudents();
    const s = document.getElementById("assignStart").value;
    const e = document.getElementById("assignEnd").value;

    if (!tids.length) { alert("En az bir öğretmen seç."); return; }
    if (!studs.length) { alert("En az bir öğrenci seç."); return; }
    if (!s || !e) { alert("Tarih aralığı seç."); return; }
    if (e < s) { alert("Bitiş tarihi başlangıçtan önce olamaz."); return; }

    let added=0;
    tids.forEach(tid=>{
      const t=teachers.find(x=>x.id===tid); if(!t) return;
      studs.forEach(st=>{
        const exists = assignments.some(a =>
          a.teacherId===tid && a.schoolNumber===st.okulNo && a.startDate===s && a.endDate===e
        );
        if (exists) return;
        assignments.push({
          id: uid(),
          teacherId: tid,
          teacherName: t.ad,
          teacherBranch: t.brans,
          studentFirstName: st.isim,
          studentLastName: st.soyisim,
          gender: st.cinsiyet,
          class: st.sinif,
          schoolNumber: st.okulNo,
          parentFirstName: st.veliAdi,
          parentLastName: st.veliSoyadi,
          parentPhone: st.veliTel,
          startDate: s,
          endDate: e,
          called: false,
          note: ""
        });
        added++;
      });
    });
    if (!added) alert("Yeni atama eklenmedi (muhtemelen aynı kayıtlar var).");
    else { renderAssignmentsTable(); alert(added+" atama oluşturuldu."); }
  }

  function removeAssignmentById(id) {
    assignments = assignments.filter(a=>a.id!==id);
    renderAssignmentsTable();
  }

  function syncReportBackToAssignments() {
    Array.from(document.querySelectorAll(".report-called")).forEach(cb=>{
      const id = cb.getAttribute("data-assignment-id");
      const a = assignments.find(x=>x.id===id);
      if (a) a.called = cb.checked;
    });
    Array.from(document.querySelectorAll(".note-cell")).forEach(t=>{
      const id = t.getAttribute("data-assignment-id");
      const a = assignments.find(x=>x.id===id);
      if (a) a.note = t.value;
    });
  }

  /* OLAYLAR */

  document.getElementById("reloadDataBtn").addEventListener("click", loadAllData);
  document.getElementById("classFilter").addEventListener("change", renderStudentsTable);
  document.getElementById("assignStart").addEventListener("change", updateAssignDatePreview);
  document.getElementById("assignEnd").addEventListener("change", updateAssignDatePreview);
  document.querySelectorAll("button[data-quick]").forEach(btn=>{
    btn.addEventListener("click", ()=>applyQuickRange(btn.getAttribute("data-quick")));
  });
  document.getElementById("selectAllStudentsBtn").addEventListener("click", ()=>{
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=true);
    document.getElementById("allRowCheckbox").checked=true;
  });
  document.getElementById("clearSelectionBtn").addEventListener("click", ()=>{
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=false);
    document.getElementById("allRowCheckbox").checked=false;
  });
  document.getElementById("allRowCheckbox").addEventListener("change",e=>{
    const c=e.target.checked;
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=c);
  });
  document.getElementById("assignBtn").addEventListener("click", createAssignments);
  document.getElementById("assignmentsBody").addEventListener("click",e=>{
    const btn=e.target.closest("button[data-del-id]");
    if(!btn) return;
    const id=btn.getAttribute("data-del-id");
    if(confirm("Bu atamayı silmek istiyor musun?")) removeAssignmentById(id);
  });
  document.getElementById("saveAssignmentsBtn").addEventListener("click", async()=>{
    syncReportBackToAssignments();
    await saveAssignmentsToFirebase();
  });
  document.getElementById("deleteAssignmentsBtn").addEventListener("click", deleteAllAssignmentsInFirebase);
  document.getElementById("generateReportsBtn").addEventListener("click", ()=>{
    syncReportBackToAssignments();
    renderReports();
  });
  document.getElementById("saveReportNotesBtn").addEventListener("click", async()=>{
    syncReportBackToAssignments();
    await saveAssignmentsToFirebase();
  });
  document.getElementById("printReportsBtn").addEventListener("click", ()=>{
    syncReportBackToAssignments();
    renderReports();
    window.print();
  });

  /* BAŞLANGIÇ */
  loadAllData();
</script>
</body>
</html>


