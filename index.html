<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ã–ÄŸrenci-Ã–ÄŸretmen Atama ve Arama Raporu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: Arial, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #222;
      background: #f3f5f7;
    }
    body {
      margin: 0;
      padding: 0 16px 40px;
      background: #f3f5f7;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 8px;
    }
    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 16px 18px;
      margin-top: 16px;
    }
    .flex {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .col {
      flex: 1 1 320px;
      min-width: 280px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    select, input[type="date"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #cbd2dd;
      font-size: 0.9rem;
    }
    select[multiple] {
      height: 160px;
    }
    button {
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
      font-weight: 500;
    }
    button.danger {
      background: #dc2626;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .pill-group button {
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
    }
    thead {
      background: #f9fafb;
    }
    /* Ã‡izgiler artÄ±k tbody arasÄ± Ã§ekileceÄŸi iÃ§in bu ayarÄ± deÄŸiÅŸtirdik */
    /* tr:nth-child(even) td { background: #f9fafb; } */
    
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5f0ff;
      color: #1d4ed8;
      margin-left: 4px;
    }
    .muted {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .date-preview {
      font-size: 0.8rem;
      margin-top: 4px;
      color: #374151;
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .report-card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 12px;
      /* KartÄ±n kendisi bÃ¶lÃ¼nebilir, iÃ§erik tbody ile korunacak */
      page-break-inside: auto !important; 
    }
    .report-card h3 {
      margin-top: 0;
      margin-bottom: 4px;
    }
    .report-meta {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 6px;
    }
    /* GÃœNCELLEME: AÃ§Ä±klama kutusu yÃ¼ksekliÄŸi dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ */
    textarea.note-cell {
      width: 100%;
      min-height: 72px; /* 144px idi, yarÄ±ya dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ */
      resize: vertical;
      font-size: 0.8rem;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 0.75rem;
      margin-right: 6px;
      margin-top: 2px;
    }
    .chip span {
      font-weight: 600;
      margin-right: 4px;
    }
    .info-block {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 6px;
    }

    .footer-note {
      margin-top: 12px;
      padding: 8px;
      text-align: center;
      font-size: 0.95rem;
      font-weight: 600;
      border: 1px dashed #2563eb;
      border-radius: 6px;
      color: #1d4ed8;
    }

    .report-page-title {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    /* GÃœNCELLEME: YazdÄ±rma iÃ§in Ã¶zel TBODY ayarÄ± */
    .student-print-block {
      page-break-inside: avoid !important;
      break-inside: avoid !important;
      border-bottom: 2px solid #ccc; /* Ã–ÄŸrencileri ayÄ±rmak iÃ§in gÃ¶rsel Ã§izgi */
    }

    /* YazdÄ±rma Ã¶zel stilleri */
    #reportContainer {
      display: none;
    }
    #printTitle {
      display: none;
    }
    @media print {
      body {
        background: #fff;
        padding: 0;
      }
      .no-print {
        display: none !important;
      }
      #reportContainer {
        display: block;
      }
      #printTitle {
        display: block;
        text-align: center;
        margin-top: 20px;
        margin-bottom: 12px;
        font-size: 1.4rem;
        font-weight: bold;
      }
      /* Kart kenarlÄ±klarÄ± yazdÄ±rmada kaldÄ±rÄ±labilir veya sadeleÅŸtirilebilir */
      .report-card {
        border: none;
        border-bottom: 1px solid #000;
        margin-bottom: 20px;
        page-break-after: always;
      }
      .report-card:last-child {
        page-break-after: auto;
      }
      /* Tablo baÅŸlÄ±ÄŸÄ±nÄ±n her sayfada tekrarlanmasÄ± iÃ§in */
      thead {
        display: table-header-group;
      }
      .footer-note {
        page-break-inside: avoid !important;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <h1 class="no-print">Ã–ÄŸrenci â€“ Ã–ÄŸretmen Atama ve Arama Takip Sistemi</h1>
  <p style="text-align:center" class="muted no-print">
    Veriler Google Sheets'ten Ã§ekilir, atamalar Firebase Realtime Database'e kaydedilir.
  </p>
  <h1 id="printTitle" style="display:none">Ã–ÄŸretmen Arama Takip Sistemi</h1>

  <div class="card no-print">
    <div class="flex-between">
      <div>
        <div class="section-title">1. Google Sheets verilerini yÃ¼kle</div>
        <div class="muted">
          Ã–ÄŸrenci ve Ã¶ÄŸretmen listeleri otomatik Ã§ekilir.
        </div>
      </div>
      <div>
        <button id="reloadDataBtn">Verileri Yeniden YÃ¼kle</button>
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <div class="col">
        <div><strong>Ã–ÄŸrenci Listesi:</strong> <span id="studentStatus" class="muted">HenÃ¼z yÃ¼klenmedi</span></div>
      </div>
      <div class="col">
        <div><strong>Ã–ÄŸretmen Listesi:</strong> <span id="teacherStatus" class="muted">HenÃ¼z yÃ¼klenmedi</span></div>
      </div>
    </div>
  </div>

  <div class="card no-print">
    <div class="section-title">2. Atama ayarlarÄ±</div>
    <div class="flex">
      <div class="col">
        <label for="classFilter">SÄ±nÄ±f SeÃ§</label>
        <select id="classFilter"></select>
        <div class="info-block">
          SÄ±nÄ±f seÃ§ince aÅŸaÄŸÄ±da o sÄ±nÄ±fa ait Ã¶ÄŸrenciler listelenir.
        </div>
      </div>
      <div class="col">
        <label for="teacherSelect">Ã–ÄŸretmen(ler) SeÃ§ <span class="badge">Ã‡oklu seÃ§im</span></label>
        <select id="teacherSelect" multiple></select>
        <div class="info-block">
          CTRL / CMD ile birden fazla Ã¶ÄŸretmen seÃ§ebilirsin.
        </div>
      </div>
      <div class="col">
        <label>Tarih AralÄ±ÄŸÄ±</label>
        <div class="flex" style="gap:8px">
          <div class="col">
            <input type="date" id="assignStart" />
          </div>
          <div class="col">
            <input type="date" id="assignEnd" />
          </div>
        </div>
        <div class="pill-group" style="margin-top:6px">
          <button type="button" class="secondary" data-quick="7">+ 7 gÃ¼n</button>
          <button type="button" class="secondary" data-quick="14">+ 14 gÃ¼n</button>
          <button type="button" class="secondary" data-quick="28">+ 28 gÃ¼n</button>
        </div>
        <div id="assignDatePreview" class="date-preview">SeÃ§ili aralÄ±k: henÃ¼z seÃ§ilmedi</div>
      </div>
    </div>

    <div class="flex-between" style="margin-top:14px">
      <div>
        <button id="selectAllStudentsBtn" class="secondary">TÃ¼m SÄ±nÄ±fÄ± SeÃ§</button>
        <button id="clearSelectionBtn" class="secondary">SeÃ§imleri Temizle</button>
      </div>
      <div>
        <button id="assignBtn">SeÃ§ili Ã–ÄŸrencilere SeÃ§ili Ã–ÄŸretmenleri Ata</button>
      </div>
    </div>

    <h3 style="margin-top:18px">SÄ±nÄ±f Ã–ÄŸrenci Listesi</h3>
    <div class="muted">Listeden Ã¶ÄŸrenci seÃ§.</div>
    <div style="max-height:260px; overflow:auto; margin-top:6px;">
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="allRowCheckbox" /></th>
            <th>Ä°sim</th>
            <th>Soyisim</th>
            <th>Cinsiyet</th>
            <th>SÄ±nÄ±f</th>
            <th>Okul NumarasÄ±</th>
            <th>Veli AdÄ±</th>
            <th>Veli SoyadÄ±</th>
            <th>Veli Telefon</th>
          </tr>
        </thead>
        <tbody id="studentsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card no-print">
    <div class="flex-between">
      <div>
        <div class="section-title">3. YapÄ±lan atamalar</div>
        <div class="muted">Atama listesi yÃ¶netimi.</div>
      </div>
      <div>
        <button id="saveAssignmentsBtn">AtamalarÄ± Firebase'e Kaydet</button>
        <button id="loadAssignmentsBtn" class="secondary">Firebase'den YÃ¼kle</button>
        <button id="deleteAssignmentsBtn" class="danger">Firebase'i Temizle</button>
        <button id="printReportsBtn">RaporlarÄ± YazdÄ±r</button>
      </div>
    </div>

    <div style="max-height:260px; overflow:auto; margin-top:8px;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ã–ÄŸretmen</th>
            <th>BranÅŸ</th>
            <th>Ä°sim</th>
            <th>Soyisim</th>
            <th>SÄ±nÄ±f</th>
            <th>Okul NumarasÄ±</th>
            <th>Veli AdÄ±</th>
            <th>Veli SoyadÄ±</th>
            <th>Veli Telefon</th>
            <th>Tarih AralÄ±ÄŸÄ±</th>
            <th>Sil</th>
          </tr>
        </thead>
        <tbody id="assignmentsBody"></tbody>
      </table>
    </div>
  </div>

  <div id="reportContainer"></div>
</div>

<script type="module">
  /* SABÄ°TLER */
  const STUDENT_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi/gviz/tq?tqx=out:csv&sheet=2025-2026";
  const TEACHER_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg/export?format=csv&gid=0";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
    authDomain: "odevfeno.firebaseapp.com",
    databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "odevfeno",
    storageBucket: "odevfeno.firebasestorage.app",
    messagingSenderId: "662757516934",
    appId: "1:662757516934:web:0042188832f63deb6fd307",
    measurementId: "G-4Q99NQRB38"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const ASSIGNMENTS_PATH = "assignments";

  let students = [];
  let teachers = [];
  let assignments = [];

  /* YARDIMCI FONKSÄ°YONLAR */
  function detectSeparator(line) {
    const comma = (line.match(/,/g) || []).length;
    const semi = (line.match(/;/g) || []).length;
    return semi > comma ? ";" : ",";
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];
    const sep = detectSeparator(lines[0]);
    const rows = [];
    for (const line of lines) {
      const row = [];
      let cur = "";
      let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i + 1] === '"') {
            cur += '"'; i++;
          } else inQ = !inQ;
        } else if (ch === sep && !inQ) {
          row.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      row.push(cur);
      rows.push(row.map(c => c.trim()));
    }
    return rows;
  }

  function findColumnIndex(headerRow, expectedHeader) {
    const target = expectedHeader.replace(/\*/g, "").trim();
    for (let i = 0; i < headerRow.length; i++) {
      const cell = (headerRow[i] || "").replace(/\*/g, "").trim();
      if (cell === target) return i;
    }
    return -1;
  }

  function toDisplayDateFromISO(iso) {
    if (!iso) return "";
    const [y, m, d] = iso.split("-");
    return `${d}.${m}.${y}`;
  }

  function formatDateForStore(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  const unique = arr => Array.from(new Set(arr));
  const uid = () => "a_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  const setText = (id, t) => { const el = document.getElementById(id); if (el) el.textContent = t; };

  /* VERÄ° Ã‡EKME */
  async function loadStudents() {
    setText("studentStatus", "YÃ¼kleniyor...");
    const res = await fetch(STUDENT_SHEET_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) { setText("studentStatus","HiÃ§ satÄ±r yok"); return; }

    const header = rows[0];
    const idxIsim      = findColumnIndex(header, "Ä°sim");
    const idxSoyisim   = findColumnIndex(header, "Soyisim*");
    const idxCinsiyet  = findColumnIndex(header, "Cinsiyet*");
    const idxSinif     = findColumnIndex(header, "SÄ±nÄ±f");
    const idxOkulNo    = findColumnIndex(header, "Okul NumarasÄ±");
    const idxVeliAdi   = findColumnIndex(header, "Veli AdÄ±");
    const idxVeliSoyad = findColumnIndex(header, "Veli SoyadÄ±");
    const idxVeliTel   = findColumnIndex(header, "Veli Telefon");

    const required = [idxIsim, idxSoyisim, idxCinsiyet, idxSinif, idxOkulNo];
    if (required.some(i => i === -1)) {
      setText("studentStatus","BaÅŸlÄ±klar bulunamadÄ±.");
      return;
    }

    students = rows.slice(1)
      .filter(r => r[idxIsim] && r[idxSinif])
      .map(r => ({
        isim: r[idxIsim] || "",
        soyisim: r[idxSoyisim] || "",
        cinsiyet: r[idxCinsiyet] || "",
        sinif: r[idxSinif] || "",
        okulNo: r[idxOkulNo] || "",
        veliAdi:    idxVeliAdi    !== -1 ? (r[idxVeliAdi]    || "") : "",
        veliSoyadi: idxVeliSoyad !== -1 ? (r[idxVeliSoyad] || "") : "",
        veliTel:    idxVeliTel    !== -1 ? (r[idxVeliTel]    || "") : ""
      }));

    setText("studentStatus", `YÃ¼klendi (${students.length} Ã¶ÄŸrenci)`);
    fillClassFilter();
    renderStudentsTable();
  }

  async function loadTeachers() {
    setText("teacherStatus", "YÃ¼kleniyor...");
    const res = await fetch(TEACHER_SHEET_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) { setText("teacherStatus","HiÃ§ satÄ±r yok"); return; }
    const header = rows[0];
    const idxId    = findColumnIndex(header, "ID");
    const idxAd    = findColumnIndex(header, "OGRETMEN_ADI");
    const idxBrans = findColumnIndex(header, "BRANS");

    teachers = rows.slice(1)
      .filter(r => r[idxAd])
      .map(r => ({
        id:    idxId    !== -1 ? (r[idxId]    || "") : "",
        ad:    idxAd    !== -1 ? (r[idxAd]    || "") : "",
        brans: idxBrans !== -1 ? (r[idxBrans] || "") : ""
      }));

    setText("teacherStatus", `YÃ¼klendi (${teachers.length} Ã¶ÄŸretmen)`);
    fillTeacherSelect();
  }

  async function loadAssignmentsFromFirebase() {
    try {
      const snap = await get(ref(db, ASSIGNMENTS_PATH));
      if (snap.exists()) {
        const val = snap.val();
        assignments = Array.isArray(val) ? val.filter(Boolean) : Object.values(val || {});
      } else assignments = [];
      renderAssignmentsTable();
    } catch (e) { console.error(e); }
  }

  async function loadAllData() {
    try {
      await Promise.all([loadStudents(), loadTeachers(), loadAssignmentsFromFirebase()]);
    } catch (e) {
      console.error(e);
      alert("Veriler yÃ¼klenirken hata oluÅŸtu.");
    }
  }

  /* EKRAN DOLDURMA */
  function fillClassFilter() {
    const sel = document.getElementById("classFilter");
    const siniflar = unique(students.map(s => s.sinif)).sort();
    sel.innerHTML = "";
    siniflar.forEach(s => {
      const o = document.createElement("option");
      o.value = s; o.textContent = s;
      sel.appendChild(o);
    });
  }

  function fillTeacherSelect() {
    const sel = document.getElementById("teacherSelect");
    sel.innerHTML = "";
    teachers.forEach(t => {
      const o = document.createElement("option");
      o.value = t.id;
      o.textContent = `${t.ad} (${t.brans})`;
      sel.appendChild(o);
    });
  }

  function renderStudentsTable() {
    const tbody = document.getElementById("studentsBody");
    const sel = document.getElementById("classFilter");
    if (!sel.value) { tbody.innerHTML=""; return; }
    const sinif = sel.value;
    let list = students.filter(s => s.sinif === sinif);
    list.sort((a, b) => {
      const numA = parseInt(a.okulNo, 10);
      const numB = parseInt(b.okulNo, 10);
      if (!isNaN(numA) && !isNaN(numB) && numA !== numB) return numA - numB;
      const nameCmp = a.isim.localeCompare(b.isim, 'tr', { sensitivity: 'base' });
      if (nameCmp !== 0) return nameCmp;
      return a.soyisim.localeCompare(b.soyisim, 'tr', { sensitivity: 'base' });
    });

    tbody.innerHTML = "";
    list.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="student-checkbox" data-okulno="${s.okulNo}"></td>
        <td>${s.isim}</td>
        <td>${s.soyisim}</td>
        <td>${s.cinsiyet}</td>
        <td>${s.sinif}</td>
        <td>${s.okulNo}</td>
        <td>${s.veliAdi}</td>
        <td>${s.veliSoyadi}</td>
        <td>${s.veliTel}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderAssignmentsTable() {
    const tbody = document.getElementById("assignmentsBody");
    tbody.innerHTML = "";
    assignments.forEach((a,i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${a.teacherName}</td>
        <td>${a.teacherBranch}</td>
        <td>${a.studentFirstName}</td>
        <td>${a.studentLastName}</td>
        <td>${a.class}</td>
        <td>${a.schoolNumber}</td>
        <td>${a.parentFirstName}</td>
        <td>${a.parentLastName}</td>
        <td>${a.parentPhone}</td>
        <td>${toDisplayDateFromISO(a.startDate)} â€“ ${toDisplayDateFromISO(a.endDate)}</td>
        <td><button type="button" class="secondary" data-del-id="${a.id}">Sil</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* GÃœNCELLEME: Rapor OluÅŸturma MantÄ±ÄŸÄ± */
  function renderReports() {
    const cont = document.getElementById("reportContainer");
    cont.innerHTML = "";
    if (!assignments.length) { cont.innerHTML="<p class='muted'>Herhangi bir atama yok.</p>"; return; }

    const filtered = assignments.slice();
    if (!filtered.length) {
      cont.innerHTML = "<p class='muted'>Herhangi bir atama yok.</p>";
      return;
    }
    
    // Ã–ÄŸretmen bazÄ±nda grupla
    const groups = {};
    filtered.forEach(a => {
      if (!groups[a.teacherId]) groups[a.teacherId] = [];
      groups[a.teacherId].push(a);
    });

    const teacherIds = Object.keys(groups);
    teacherIds.forEach((tid) => {
      const list = groups[tid];
      const tName = list[0].teacherName;
      const tBranch = list[0].teacherBranch;
      const minStart = list.reduce((m,a)=>!m||a.startDate < m ? a.startDate : m, null);
      const maxEnd    = list.reduce((m,a)=>!m||a.endDate > m ? a.endDate : m, null);

      // SÄ±ralama
      list.sort((a,b) => {
        const nameCompare = a.studentFirstName.localeCompare(b.studentFirstName, 'tr', { sensitivity: 'base' });
        if (nameCompare !== 0) return nameCompare;
        const numA = parseInt(a.schoolNumber,10);
        const numB = parseInt(b.schoolNumber,10);
        if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
        return String(a.schoolNumber).localeCompare(String(b.schoolNumber));
      });

      const card = document.createElement("div");
      card.className = "report-card";

      // Kart BaÅŸlÄ±ÄŸÄ±
      let html = `
        <div class="report-page-title">Ã–ÄŸretmen Arama Listesi</div>
        <h3>${tName}</h3>
        <div class="report-meta">
          <span class="chip"><span>BranÅŸ:</span>${tBranch}</span>
          <span class="chip"><span>Arama SayÄ±sÄ±:</span>${list.length}</span>
          <span class="chip"><span>Tarih:</span>${toDisplayDateFromISO(minStart)} â€“ ${toDisplayDateFromISO(maxEnd)}</span>
        </div>
      `;
      card.innerHTML = html;

      // Tabloyu oluÅŸturuyoruz
      const table = document.createElement("table");
      // Thead: Her sayfada gÃ¶rÃ¼nmesi iÃ§in
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>#</th>
          <th>Ä°sim</th>
          <th>Soyisim</th>
          <th>Cinsiyet</th>
          <th>SÄ±nÄ±f</th>
          <th>Okul No</th>
          <th>Veli AdÄ±</th>
          <th>Veli SoyadÄ±</th>
          <th>Veli Telefon</th>
          <th>Arama?</th>
        </tr>
      `;
      table.appendChild(thead);

      // Her Ã¶ÄŸrenci iÃ§in ayrÄ± bir TBODY oluÅŸturup 'avoid page break' ekleyeceÄŸiz.
      // Bu, HTML standartlarÄ±nda tablolarÄ± bÃ¶lmeden tutmanÄ±n en saÄŸlam yoludur.
      list.forEach((a, i) => {
        const tbody = document.createElement("tbody");
        tbody.className = "student-print-block"; // CSS'de page-break-inside: avoid var

        tbody.innerHTML = `
          <tr>
            <td>${i+1}</td>
            <td>${a.studentFirstName}</td>
            <td>${a.studentLastName}</td>
            <td>${a.gender}</td>
            <td>${a.class}</td>
            <td>${a.schoolNumber}</td>
            <td>${a.parentFirstName}</td>
            <td>${a.parentLastName}</td>
            <td>${a.parentPhone}</td>
            <td style="text-align:center;">
              <input type="checkbox" class="report-called" data-assignment-id="${a.id}" ${a.called ? "checked" : ""}>
            </td>
          </tr>
          <tr>
            <td colspan="10">
              <div style="font-size:0.8rem; font-weight:600; margin-bottom:4px;">AÃ§Ä±klama</div>
              <textarea class="note-cell" data-assignment-id="${a.id}">${a.note || ""}</textarea>
            </td>
          </tr>
        `;
        table.appendChild(tbody);
      });

      card.appendChild(table);

      // Footer Not
      const footerNote = document.createElement("div");
      footerNote.className = "footer-note";
      footerNote.textContent = "ðŸ“Œ Listeyi lÃ¼tfen zÃ¼mre baÅŸkanÄ±na zamanÄ±nda teslim ediniz.";
      card.appendChild(footerNote);

      cont.appendChild(card);
    });
  }

  /* FIREBASE VE DÄ°ÄžER FONKSÄ°YONLAR */
  async function saveAssignmentsToFirebase() {
    try {
      await set(ref(db, ASSIGNMENTS_PATH), assignments);
      alert("Atamalar kaydedildi.");
    } catch (e) {
      console.error(e);
      alert("Hata oluÅŸtu.");
    }
  }

  async function deleteAllAssignmentsInFirebase() {
    if (!confirm("TÃ¼m atamalarÄ± silmek istiyor musun?")) return;
    try {
      await remove(ref(db, ASSIGNMENTS_PATH));
      assignments = [];
      renderAssignmentsTable();
      document.getElementById("reportContainer").innerHTML="";
      alert("Silindi.");
    } catch (e) { console.error(e); alert("Hata."); }
  }

  const getSelectedTeacherIds = () => Array.from(document.getElementById("teacherSelect").selectedOptions).map(o => o.value);
  
  function getSelectedStudents() {
    const okulNos = Array.from(document.querySelectorAll(".student-checkbox:checked")).map(cb => cb.getAttribute("data-okulno"));
    return students.filter(s => okulNos.includes(s.okulNo));
  }

  function updateAssignDatePreview() {
    const s = document.getElementById("assignStart").value;
    const e = document.getElementById("assignEnd").value;
    const el = document.getElementById("assignDatePreview");
    if (!s || !e) { el.textContent="SeÃ§ili aralÄ±k: henÃ¼z seÃ§ilmedi"; return; }
    el.textContent = "SeÃ§ili aralÄ±k: " + toDisplayDateFromISO(s) + " â€“ " + toDisplayDateFromISO(e);
  }

  function applyQuickRange(days) {
    const sInput = document.getElementById("assignStart");
    const eInput = document.getElementById("assignEnd");
    let s = sInput.value;
    if (!s) { const t=new Date(); s=formatDateForStore(t); sInput.value=s; }
    const [y,m,d]=s.split("-");
    const base = new Date(+y,+m-1,+d);
    const end  = new Date(base.getTime());
    end.setDate(end.getDate()+Number(days));
    eInput.value = formatDateForStore(end);
    updateAssignDatePreview();
  }

  function createAssignments() {
    const tids = getSelectedTeacherIds();
    const studs = getSelectedStudents();
    const s = document.getElementById("assignStart").value;
    const e = document.getElementById("assignEnd").value;

    if (!tids.length || !studs.length || !s || !e) { alert("Eksik seÃ§im."); return; }
    if (e < s) { alert("Tarih hatasÄ±."); return; }

    let added=0;
    tids.forEach(tid=>{
      const t=teachers.find(x=>x.id===tid); if(!t) return;
      studs.forEach(st=>{
        const exists = assignments.some(a => a.teacherId===tid && a.schoolNumber===st.okulNo && a.startDate===s && a.endDate===e);
        if (exists) return;
        assignments.push({
          id: uid(),
          teacherId: tid,
          teacherName: t.ad,
          teacherBranch: t.brans,
          studentFirstName: st.isim,
          studentLastName: st.soyisim,
          gender: st.cinsiyet,
          class: st.sinif,
          schoolNumber: st.okulNo,
          parentFirstName: st.veliAdi,
          parentLastName: st.veliSoyadi,
          parentPhone: st.veliTel,
          startDate: s,
          endDate: e,
          called: false,
          note: ""
        });
        added++;
      });
    });
    if (!added) alert("Yeni atama eklenmedi.");
    else { renderAssignmentsTable(); alert(added+" atama oluÅŸturuldu."); }
  }

  function removeAssignmentById(id) {
    assignments = assignments.filter(a=>a.id!==id);
    renderAssignmentsTable();
  }

  function syncReportBackToAssignments() {
    Array.from(document.querySelectorAll(".report-called")).forEach(cb=>{
      const id = cb.getAttribute("data-assignment-id");
      const a = assignments.find(x=>x.id===id);
      if (a) a.called = cb.checked;
    });
    Array.from(document.querySelectorAll(".note-cell")).forEach(t=>{
      const id = t.getAttribute("data-assignment-id");
      const a = assignments.find(x=>x.id===id);
      if (a) a.note = t.value;
    });
  }

  document.getElementById("reloadDataBtn").addEventListener("click", loadAllData);
  document.getElementById("classFilter").addEventListener("change", renderStudentsTable);
  document.getElementById("assignStart").addEventListener("change", updateAssignDatePreview);
  document.getElementById("assignEnd").addEventListener("change", updateAssignDatePreview);
  document.querySelectorAll("button[data-quick]").forEach(btn=>{
    btn.addEventListener("click", ()=>applyQuickRange(btn.getAttribute("data-quick")));
  });
  document.getElementById("selectAllStudentsBtn").addEventListener("click", ()=>{
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=true);
    document.getElementById("allRowCheckbox").checked=true;
  });
  document.getElementById("clearSelectionBtn").addEventListener("click", ()=>{
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=false);
    document.getElementById("allRowCheckbox").checked=false;
  });
  document.getElementById("allRowCheckbox").addEventListener("change",e=>{
    const c=e.target.checked;
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=c);
  });
  document.getElementById("assignBtn").addEventListener("click", createAssignments);
  document.getElementById("assignmentsBody").addEventListener("click",e=>{
    const btn=e.target.closest("button[data-del-id]");
    if(!btn) return;
    if(confirm("Silinsin mi?")) removeAssignmentById(btn.getAttribute("data-del-id"));
  });
  document.getElementById("saveAssignmentsBtn").addEventListener("click", async()=>{
    syncReportBackToAssignments();
    await saveAssignmentsToFirebase();
  });
  document.getElementById("deleteAssignmentsBtn").addEventListener("click", deleteAllAssignmentsInFirebase);
  document.getElementById("loadAssignmentsBtn").addEventListener("click", async()=>{
    await loadAssignmentsFromFirebase();
  });
  document.getElementById("printReportsBtn").addEventListener("click", ()=>{
    syncReportBackToAssignments();
    renderReports();
    window.print();
  });

  loadAllData();
</script>
</body>
</html>
