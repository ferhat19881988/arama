<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ã–ÄŸrenci-Ã–ÄŸretmen Atama ve Arama Raporu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      background: #f0f2f5;
    }
    body {
      margin: 0;
      padding: 0 16px 40px;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 8px;
      color: #1a202c;
    }
    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      padding: 20px;
      margin-top: 20px;
      border: 1px solid #e2e8f0;
    }
    .flex {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .col {
      flex: 1 1 300px;
      min-width: 250px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: #4a5568;
    }
    select, input[type="date"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e0;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    select:focus, input:focus, textarea:focus {
      border-color: #3182ce;
      outline: none;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }
    select[multiple] {
      height: 160px;
    }
    button {
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #3182ce;
      color: white;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    button:hover {
      background: #2c5282;
    }
    button.secondary {
      background: #edf2f7;
      color: #2d3748;
    }
    button.secondary:hover {
      background: #e2e8f0;
    }
    button.danger {
      background: #e53e3e;
    }
    button.danger:hover {
      background: #c53030;
    }
    button.warning {
      background: #dd6b20;
      color: white;
    }
    button.warning:hover {
      background: #c05621;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .pill-group button {
      padding: 6px 14px;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 10px 12px;
      text-align: left;
    }
    thead {
      background: #f7fafc;
    }
    th {
      font-weight: 600;
      color: #4a5568;
    }
    
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #ebf8ff;
      color: #2b6cb0;
      margin-left: 4px;
      font-weight: normal;
    }
    .muted {
      font-size: 0.85rem;
      color: #718096;
    }
    .date-preview {
      font-size: 0.85rem;
      margin-top: 6px;
      color: #4a5568;
      font-weight: 600;
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: #2d3748;
    }

    /* Ä°statistik KutularÄ± */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    .stat-box {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .stat-label {
      font-size: 0.85rem;
      color: #718096;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 1.2rem;
      color: #2d3748;
      font-weight: 700;
    }

    /* RAPOR VE YAZDIRMA TASARIMI */
    
    /* Her sayfa (kaÄŸÄ±t) iÃ§in kapsayÄ±cÄ± */
    .print-page-sheet {
      background: #fff;
      border: 1px solid #e2e8f0; 
      margin-bottom: 30px;
      /* Ekranda gÃ¶relim diye padding */
      padding: 20px; 
      position: relative;
      /* YazdÄ±rmada sayfa kÄ±rÄ±lÄ±mÄ± saÄŸlar */
      page-break-after: always;
      break-after: page;
      min-height: 25cm; /* A4 boyutunu simÃ¼le etmeye Ã§alÄ±ÅŸÄ±r */
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .report-header-box {
      background: #f7fafc;
      padding: 10px 15px;
      border-bottom: 2px solid #3182ce;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .report-header-info h3 {
      margin: 0;
      font-size: 1.2rem;
      color: #2c5282;
    }
    .report-header-meta {
      display: flex;
      gap: 15px;
      margin-top: 4px;
      font-size: 0.85rem;
      color: #4a5568;
    }

    textarea.note-cell {
      width: 100%;
      min-height: 35px;
      resize: vertical;
      font-size: 0.8rem;
      border: 1px dashed #cbd5e0;
      background: #fffaf0;
      padding: 4px;
      margin-top: 2px;
      font-family: 'Segoe UI', sans-serif;
    }

    .info-block {
      font-size: 0.8rem;
      color: #718096;
      margin-top: 6px;
    }

    /* Footer Note: Sayfa altÄ±ndaki uyarÄ± */
    .footer-note {
      margin-top: auto; /* SayfanÄ±n en altÄ±na it */
      padding: 10px;
      text-align: center;
      font-size: 0.8rem;
      font-weight: 600;
      border-top: 1px dashed #cbd5e1;
      color: #475569;
    }

    /* Page Number: SaÄŸ alt kÃ¶ÅŸe */
    .page-number-box {
      text-align: right;
      font-size: 0.8rem;
      font-weight: bold;
      color: #000;
      margin-top: 5px;
      border-top: 1px solid #000;
      padding-top: 5px;
    }

    #reportContainer {
      display: none; /* YazdÄ±r denilene kadar gizli tutabiliriz ya da aÅŸaÄŸÄ±da gÃ¶steririz */
      margin-top: 40px;
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
        font-family: 'Times New Roman', serif;
        font-size: 11pt;
      }
      .no-print {
        display: none !important;
      }
      .app-shell {
        max-width: 100%;
        margin: 0;
      }
      #reportContainer {
        display: block;
      }
      
      .print-page-sheet {
        border: none;
        margin: 0;
        padding: 0;
        /* YazÄ±cÄ±da tam sayfa */
        height: 100vh; 
        page-break-after: always;
        position: relative;
      }
      
      .report-header-box {
        background: #f0f0f0 !important;
        border: 1px solid #000;
        border-bottom: 2px solid #000;
        color: #000;
        padding: 8px;
        -webkit-print-color-adjust: exact;
      }
      .report-header-info h3 {
        color: #000;
        font-size: 14pt;
      }
      .report-header-meta {
        color: #000 !important;
      }
      
      table {
        font-size: 9pt;
        margin-top: 5px;
        border: 1px solid #000;
        width: 100%;
      }
      th {
        background-color: #ddd !important;
        color: #000;
        font-weight: bold;
        border: 1px solid #000;
        padding: 4px;
        -webkit-print-color-adjust: exact;
      }
      td {
        border: 1px solid #000;
        padding: 4px;
      }
      
      textarea.note-cell {
        border: 1px solid #999;
        background: transparent;
        min-height: 40px;
        resize: none; /* YazdÄ±rÄ±rken boyut deÄŸiÅŸmesin */
        overflow: hidden;
        font-family: inherit;
      }
      
      .footer-note {
        border: none;
        border-top: 1px solid #000;
        color: #000;
        margin-bottom: 10px;
      }
      
      /* Sayfa numarasÄ± iÃ§in Ã¶zel stil */
      .page-number-box {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 100%;
        text-align: right;
        font-size: 10pt;
        border: none;
        padding-bottom: 5px;
      }
      
      input[type="checkbox"] {
        transform: scale(1.2);
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <h1 class="no-print">Ã–ÄŸrenci â€“ Ã–ÄŸretmen Atama ve Arama Takip Sistemi</h1>
  <p style="text-align:center" class="muted no-print">
    Veriler Google Sheets'ten Ã§ekilir, atamalar Firebase Realtime Database'e kaydedilir.
  </p>

  <div class="card no-print">
    <div class="flex-between">
      <div>
        <div class="section-title">1. Veri KaynaÄŸÄ±</div>
        <div class="muted">
          Listeler Google Sheets Ã¼zerinden Ã§ekilir.
        </div>
      </div>
      <div>
        <button id="reloadDataBtn">Verileri Yeniden YÃ¼kle</button>
      </div>
    </div>
    
    <div class="stat-grid">
      <div class="stat-box">
        <span class="stat-label">Ã–ÄŸrenci Durumu</span>
        <span id="studentStatus" class="stat-value">YÃ¼kleniyor...</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Ã–ÄŸretmen Durumu</span>
        <span id="teacherStatus" class="stat-value">YÃ¼kleniyor...</span>
      </div>
    </div>
  </div>

  <div class="card no-print">
    <div class="section-title">2. Atama Ä°ÅŸlemleri</div>
    <div class="flex">
      <div class="col">
        <label for="classFilter">SÄ±nÄ±f SeÃ§iniz</label>
        <select id="classFilter"></select>
      </div>
      <div class="col">
        <label for="teacherSelect">Ã–ÄŸretmen SeÃ§iniz <span class="badge">Ã‡oklu</span></label>
        <select id="teacherSelect" multiple></select>
        <div class="info-block">Birden fazla seÃ§im iÃ§in CTRL tuÅŸuna basÄ±lÄ± tutun.</div>
      </div>
      <div class="col">
        <label>Arama Tarih AralÄ±ÄŸÄ±</label>
        <div class="flex" style="gap:8px">
          <div style="flex:1"><input type="date" id="assignStart" /></div>
          <div style="flex:1"><input type="date" id="assignEnd" /></div>
        </div>
        <div class="pill-group" style="margin-top:8px">
          <button type="button" class="secondary" data-quick="7">+1 Hafta</button>
          <button type="button" class="secondary" data-quick="14">+2 Hafta</button>
          <button type="button" class="secondary" data-quick="21">+3 Hafta</button>
          <button type="button" class="secondary" data-quick="28">+4 Hafta</button>
        </div>
        <div id="assignDatePreview" class="date-preview">AralÄ±k seÃ§ilmedi.</div>
      </div>
    </div>

    <div class="flex-between" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
      <div>
        <button id="selectAllStudentsBtn" class="secondary">TÃ¼m SÄ±nÄ±fÄ± SeÃ§</button>
        <button id="clearSelectionBtn" class="secondary">SeÃ§imi KaldÄ±r</button>
      </div>
      <div>
        <button id="assignBtn">âœ… AtamayÄ± OluÅŸtur</button>
      </div>
    </div>

    <h3 style="margin-top:20px; font-size:1.1rem; color:#2d3748;">Ã–ÄŸrenci Listesi</h3>
    <div class="muted">SÄ±ralama: Ä°sim (A-Z) > Okul No</div>
    <div style="max-height:300px; overflow:auto; margin-top:8px; border:1px solid #e2e8f0; border-radius:6px;">
      <table>
        <thead>
          <tr>
            <th style="width:40px; text-align:center;"><input type="checkbox" id="allRowCheckbox" /></th>
            <th>Ä°sim</th>
            <th>Soyisim</th>
            <th>Cinsiyet</th>
            <th>SÄ±nÄ±f</th>
            <th>Okul No</th>
            <th>Veli AdÄ±</th>
            <th>Veli SoyadÄ±</th>
            <th>Veli Tel</th>
          </tr>
        </thead>
        <tbody id="studentsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card no-print">
    <div class="flex-between">
      <div>
        <div class="section-title">3. YapÄ±lan Atamalar & Rapor</div>
        <div class="muted">OluÅŸturulan listeyi kontrol edin ve yazdÄ±rÄ±n.</div>
      </div>
      <div style="display:flex; gap:10px;">
        <button id="clearLocalListBtn" class="warning">ğŸ§¹ Listeyi Temizle</button>
        <button id="saveAssignmentsBtn">ğŸ’¾ Firebase'e Kaydet</button>
        <button id="deleteAssignmentsBtn" class="danger">ğŸ—‘ï¸ Firebase'i Sil</button>
        <button id="printReportsBtn">ğŸ–¨ï¸ RaporlarÄ± YazdÄ±r</button>
      </div>
    </div>

    <div style="max-height:300px; overflow:auto; margin-top:15px; border:1px solid #e2e8f0; border-radius:6px;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ã–ÄŸretmen</th>
            <th>BranÅŸ</th>
            <th>Ä°sim</th>
            <th>Soyisim</th>
            <th>SÄ±nÄ±f</th>
            <th>No</th>
            <th>Veli</th>
            <th>Tel</th>
            <th>Tarih</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="assignmentsBody"></tbody>
      </table>
    </div>
  </div>

  <div id="reportContainer">
    </div>
</div>

<script type="module">
  /* SABÄ°TLER */
  const STUDENT_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi/gviz/tq?tqx=out:csv&sheet=2025-2026";
  const TEACHER_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg/export?format=csv&gid=0";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
    authDomain: "odevfeno.firebaseapp.com",
    databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "odevfeno",
    storageBucket: "odevfeno.firebasestorage.app",
    messagingSenderId: "662757516934",
    appId: "1:662757516934:web:0042188832f63deb6fd307",
    measurementId: "G-4Q99NQRB38"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const ASSIGNMENTS_PATH = "assignments";

  let students = [];
  let teachers = [];
  let assignments = [];

  /* YARDIMCI FONKSÄ°YONLAR */
  function detectSeparator(line) {
    const comma = (line.match(/,/g) || []).length;
    const semi = (line.match(/;/g) || []).length;
    return semi > comma ? ";" : ",";
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];
    const sep = detectSeparator(lines[0]);
    const rows = [];
    for (const line of lines) {
      const row = [];
      let cur = "";
      let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i + 1] === '"') {
            cur += '"'; i++;
          } else inQ = !inQ;
        } else if (ch === sep && !inQ) {
          row.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      row.push(cur);
      rows.push(row.map(c => c.trim()));
    }
    return rows;
  }

  function findColumnIndex(headerRow, expectedHeader) {
    const target = expectedHeader.replace(/\*/g, "").trim();
    for (let i = 0; i < headerRow.length; i++) {
      const cell = (headerRow[i] || "").replace(/\*/g, "").trim();
      if (cell === target) return i;
    }
    return -1;
  }

  function toDisplayDateFromISO(iso) {
    if (!iso) return "";
    const [y, m, d] = iso.split("-");
    return `${d}.${m}.${y}`;
  }

  function formatDateForStore(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function sortStudentsHelper(a, b) {
    const nameA = (a.isim || a.studentFirstName || "").toLocaleLowerCase('tr');
    const nameB = (b.isim || b.studentFirstName || "").toLocaleLowerCase('tr');
    const nameComp = nameA.localeCompare(nameB, 'tr');
    if (nameComp !== 0) return nameComp;
    const numA = parseInt(a.okulNo || a.schoolNumber, 10);
    const numB = parseInt(b.okulNo || b.schoolNumber, 10);
    if (!isNaN(numA) && !isNaN(numB)) {
      return numA - numB;
    }
    return (a.okulNo || "").localeCompare(b.okulNo || "");
  }

  const unique = arr => Array.from(new Set(arr));
  const uid = () => "a_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  const setText = (id, t) => { const el = document.getElementById(id); if (el) el.textContent = t; };

  /* VERÄ° Ã‡EKME */
  async function loadStudents() {
    setText("studentStatus", "YÃ¼kleniyor...");
    const res = await fetch(STUDENT_SHEET_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) { setText("studentStatus","Veri yok"); return; }

    const header = rows[0];
    const idxIsim        = findColumnIndex(header, "Ä°sim");
    const idxSoyisim     = findColumnIndex(header, "Soyisim*");
    const idxCinsiyet    = findColumnIndex(header, "Cinsiyet*");
    const idxSinif       = findColumnIndex(header, "SÄ±nÄ±f");
    const idxOkulNo      = findColumnIndex(header, "Okul NumarasÄ±");
    const idxVeliAdi     = findColumnIndex(header, "Veli AdÄ±");
    const idxVeliSoyad   = findColumnIndex(header, "Veli SoyadÄ±");
    const idxVeliTel     = findColumnIndex(header, "Veli Telefon");

    const required = [idxIsim, idxSoyisim, idxCinsiyet, idxSinif, idxOkulNo];
    if (required.some(i => i === -1)) {
      setText("studentStatus","HatalÄ± BaÅŸlÄ±klar");
      return;
    }

    students = rows.slice(1)
      .filter(r => r[idxIsim] && r[idxSinif])
      .map(r => ({
        isim: r[idxIsim] || "",
        soyisim: r[idxSoyisim] || "",
        cinsiyet: r[idxCinsiyet] || "",
        sinif: r[idxSinif] || "",
        okulNo: r[idxOkulNo] || "",
        veliAdi:    idxVeliAdi    !== -1 ? (r[idxVeliAdi]    || "") : "",
        veliSoyadi: idxVeliSoyad !== -1 ? (r[idxVeliSoyad] || "") : "",
        veliTel:    idxVeliTel    !== -1 ? (r[idxVeliTel]    || "") : ""
      }));

    setText("studentStatus", `${students.length} Ã–ÄŸrenci`);
    fillClassFilter();
    renderStudentsTable();
  }

  async function loadTeachers() {
    setText("teacherStatus", "YÃ¼kleniyor...");
    const res = await fetch(TEACHER_SHEET_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) { setText("teacherStatus","Veri yok"); return; }
    const header = rows[0];
    const idxId    = findColumnIndex(header, "ID");
    const idxAd    = findColumnIndex(header, "OGRETMEN_ADI");
    const idxBrans = findColumnIndex(header, "BRANS");

    teachers = rows.slice(1)
      .filter(r => r[idxAd])
      .map(r => ({
        id:    idxId    !== -1 ? (r[idxId]    || "") : "",
        ad:    idxAd    !== -1 ? (r[idxAd]    || "") : "",
        brans: idxBrans !== -1 ? (r[idxBrans] || "") : ""
      }));

    setText("teacherStatus", `${teachers.length} Ã–ÄŸretmen`);
    fillTeacherSelect();
  }

  async function loadAssignmentsFromFirebase() {
    try {
      const snap = await get(ref(db, ASSIGNMENTS_PATH));
      if (snap.exists()) {
        const val = snap.val();
        assignments = Array.isArray(val) ? val.filter(Boolean) : Object.values(val || {});
      } else assignments = [];
      renderAssignmentsTable();
    } catch (e) { console.error(e); }
  }

  async function loadAllData() {
    try {
      await Promise.all([loadStudents(), loadTeachers(), loadAssignmentsFromFirebase()]);
    } catch (e) {
      console.error(e);
      alert("Veriler yÃ¼klenirken hata oluÅŸtu.");
    }
  }

  /* EKRAN DOLDURMA */
  function fillClassFilter() {
    const sel = document.getElementById("classFilter");
    const siniflar = unique(students.map(s => s.sinif)).sort();
    sel.innerHTML = "";
    siniflar.forEach(s => {
      const o = document.createElement("option");
      o.value = s; o.textContent = s;
      sel.appendChild(o);
    });
  }

  function fillTeacherSelect() {
    const sel = document.getElementById("teacherSelect");
    sel.innerHTML = "";
    teachers.forEach(t => {
      const o = document.createElement("option");
      o.value = t.id;
      o.textContent = `${t.ad} (${t.brans})`;
      sel.appendChild(o);
    });
  }

  function renderStudentsTable() {
    const tbody = document.getElementById("studentsBody");
    const sel = document.getElementById("classFilter");
    if (!sel.value) { tbody.innerHTML=""; return; }
    const sinif = sel.value;
    let list = students.filter(s => s.sinif === sinif);
    
    list.sort(sortStudentsHelper);

    tbody.innerHTML = "";
    list.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:center;"><input type="checkbox" class="student-checkbox" data-okulno="${s.okulNo}"></td>
        <td>${s.isim}</td>
        <td>${s.soyisim}</td>
        <td>${s.cinsiyet}</td>
        <td>${s.sinif}</td>
        <td>${s.okulNo}</td>
        <td>${s.veliAdi}</td>
        <td>${s.veliSoyadi}</td>
        <td>${s.veliTel}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderAssignmentsTable() {
    const tbody = document.getElementById("assignmentsBody");
    tbody.innerHTML = "";
    
    assignments.sort(sortStudentsHelper);

    assignments.forEach((a,i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${a.teacherName}</td>
        <td>${a.teacherBranch}</td>
        <td>${a.studentFirstName}</td>
        <td>${a.studentLastName}</td>
        <td>${a.class}</td>
        <td>${a.schoolNumber}</td>
        <td>${a.parentFirstName} ${a.parentLastName}</td>
        <td>${a.parentPhone}</td>
        <td>${toDisplayDateFromISO(a.startDate)}<br>${toDisplayDateFromISO(a.endDate)}</td>
        <td><button type="button" class="danger" style="padding:4px 8px; font-size:0.8rem" data-del-id="${a.id}">Sil</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* GÃœNCELLENMÄ°Å RAPOR OLUÅTURMA FONKSÄ°YONU */
  function renderReports() {
    const cont = document.getElementById("reportContainer");
    cont.innerHTML = "";
    if (!assignments.length) { cont.innerHTML="<p class='muted'>Herhangi bir atama yok.</p>"; return; }

    const filtered = assignments.slice();
    if (!filtered.length) return;
    
    // Ã–ÄŸretmenlere gÃ¶re grupla
    const groups = {};
    filtered.forEach(a => {
      if (!groups[a.teacherId]) groups[a.teacherId] = [];
      groups[a.teacherId].push(a);
    });

    const teacherIds = Object.keys(groups);

    // Her Ã¶ÄŸretmeni dÃ¶n
    teacherIds.forEach((tid) => {
      let list = groups[tid];
      
      // Ã–ÄŸrenci ismine gÃ¶re sÄ±rala
      list.sort(sortStudentsHelper);

      // Ã–ÄŸretmen bilgileri
      const tName = list[0].teacherName;
      const tBranch = list[0].teacherBranch;
      const minStart = list.reduce((m,a)=>!m||a.startDate < m ? a.startDate : m, null);
      const maxEnd    = list.reduce((m,a)=>!m||a.endDate > m ? a.endDate : m, null);
      const totalStudents = list.length;

      // SAYFALAMA AYARI (A4'e not alanlarÄ± ile birlikte rahat sÄ±ÄŸmasÄ± iÃ§in)
      const STUDENTS_PER_PAGE = 13; // Bu sayÄ±yÄ± deneme yanÄ±lma ile artÄ±rÄ±p azaltabilirsiniz.
      const totalPages = Math.ceil(list.length / STUDENTS_PER_PAGE);

      // Her sayfa iÃ§in dÃ¶ngÃ¼
      for (let page = 0; page < totalPages; page++) {
        // Bu sayfada gÃ¶sterilecek dilim
        const chunk = list.slice(page * STUDENTS_PER_PAGE, (page + 1) * STUDENTS_PER_PAGE);
        
        // Sayfa container'Ä± oluÅŸtur (CSS'de page-break-after var)
        const sheet = document.createElement("div");
        sheet.className = "print-page-sheet";

        // 1. Header (Her sayfada gÃ¶rÃ¼nsÃ¼n)
        let html = `
          <div class="report-header-box">
            <div class="report-header-info">
              <h3>${tName}</h3>
              <div class="report-header-meta">
                <span><strong>BranÅŸ:</strong> ${tBranch}</span>
                <span>â€¢</span>
                <span><strong>Ã–ÄŸrenci:</strong> ${totalStudents}</span>
                <span>â€¢</span>
                <span><strong>Tarih:</strong> ${toDisplayDateFromISO(minStart)} â€“ ${toDisplayDateFromISO(maxEnd)}</span>
              </div>
            </div>
          </div>
        `;
        
        // 2. Tablo BaÅŸlangÄ±cÄ±
        html += `
          <table>
            <thead>
              <tr>
                <th style="width:30px">#</th>
                <th>Ã–ÄŸrenci AdÄ± SoyadÄ±</th>
                <th style="width:50px">SÄ±nÄ±f</th>
                <th style="width:60px">No</th>
                <th>Veli AdÄ± SoyadÄ±</th>
                <th>Ä°letiÅŸim</th>
                <th style="width:50px; text-align:center;">Arama</th>
              </tr>
            </thead>
            <tbody class="student-print-block">
        `;

        // 3. Tablo SatÄ±rlarÄ± (Chunk iÃ§indeki Ã¶ÄŸrenciler)
        chunk.forEach((a, i) => {
          // GerÃ§ek sÄ±ra numarasÄ±nÄ± bul (Sayfa 0 ise 1..13, Sayfa 1 ise 14..26 gibi)
          const globalIndex = (page * STUDENTS_PER_PAGE) + i + 1;
          
          html += `
            <tr>
              <td rowspan="2" style="vertical-align:top; font-weight:bold;">${globalIndex}</td>
              <td style="font-weight:600">${a.studentFirstName} ${a.studentLastName}</td>
              <td>${a.class}</td>
              <td>${a.schoolNumber}</td>
              <td>${a.parentFirstName} ${a.parentLastName}</td>
              <td>${a.parentPhone}</td>
              <td style="text-align:center; vertical-align:middle;">
                <input type="checkbox" class="report-called" data-assignment-id="${a.id}" ${a.called ? "checked" : ""}>
              </td>
            </tr>
            <tr>
              <td colspan="6" style="border-top:none; padding-top:2px;">
                <div style="font-size:0.75rem; color:#666; margin-bottom:2px;">GÃ¶rÃ¼ÅŸme NotlarÄ± / AÃ§Ä±klama:</div>
                <textarea class="note-cell" data-assignment-id="${a.id}">${a.note || ""}</textarea>
              </td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        
        sheet.innerHTML = html;

        // 4. Footer Note (Varsa her sayfaya veya sadece sona konabilir, burada her sayfaya koyuyoruz)
        const footerNote = document.createElement("div");
        footerNote.className = "footer-note";
        footerNote.textContent = "ğŸ“Œ Not: Bu liste tamamlandÄ±ÄŸÄ±nda lÃ¼tfen ilgili zÃ¼mre baÅŸkanÄ±na teslim ediniz.";
        sheet.appendChild(footerNote);

        // 5. Sayfa NumarasÄ± (SaÄŸ alt kÃ¶ÅŸe, Ã–ÄŸretmen bazlÄ± sÄ±fÄ±rlama)
        const pageNumBox = document.createElement("div");
        pageNumBox.className = "page-number-box";
        pageNumBox.textContent = `Sayfa ${page + 1} / ${totalPages}`; // Ã–rn: Sayfa 1 / 3
        sheet.appendChild(pageNumBox);

        cont.appendChild(sheet);
      }
    });

    // Rapor oluÅŸturulduktan sonra ekranÄ± gÃ¶ster (display:block) - CSS'de printte zaten gÃ¶rÃ¼nÃ¼yor
    document.getElementById("reportContainer").style.display = "block";
  }

  /* Ä°ÅLEVLER */
  async function saveAssignmentsToFirebase() {
    try {
      await set(ref(db, ASSIGNMENTS_PATH), assignments);
      alert("TÃ¼m atamalar veritabanÄ±na kaydedildi.");
    } catch (e) {
      console.error(e);
      alert("Kaydetme hatasÄ±: " + e.message);
    }
  }

  async function deleteAllAssignmentsInFirebase() {
    if (!confirm("âš ï¸ DÄ°KKAT: VeritabanÄ±ndaki TÃœM atamalar silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?")) return;
    try {
      await remove(ref(db, ASSIGNMENTS_PATH));
      assignments = [];
      renderAssignmentsTable();
      document.getElementById("reportContainer").innerHTML="";
      alert("VeritabanÄ± temizlendi.");
    } catch (e) { console.error(e); alert("Silme hatasÄ±."); }
  }

  function clearLocalList() {
    if (!confirm("Ekrandaki liste temizlensin mi? (VeritabanÄ±ndan silinmez, sadece gÃ¶rÃ¼nÃ¼m sÄ±fÄ±rlanÄ±r).")) return;
    assignments = [];
    renderAssignmentsTable();
    document.getElementById("reportContainer").innerHTML="";
  }

  const getSelectedTeacherIds = () => Array.from(document.getElementById("teacherSelect").selectedOptions).map(o => o.value);
  
  function getSelectedStudents() {
    const okulNos = Array.from(document.querySelectorAll(".student-checkbox:checked")).map(cb => cb.getAttribute("data-okulno"));
    return students.filter(s => okulNos.includes(s.okulNo));
  }

  function updateAssignDatePreview() {
    const s = document.getElementById("assignStart").value;
    const e = document.getElementById("assignEnd").value;
    const el = document.getElementById("assignDatePreview");
    if (!s || !e) { el.textContent="AralÄ±k seÃ§ilmedi."; return; }
    el.textContent = toDisplayDateFromISO(s) + " â€“ " + toDisplayDateFromISO(e);
  }

  function applyQuickRange(days) {
    const sInput = document.getElementById("assignStart");
    const eInput = document.getElementById("assignEnd");
    let s = sInput.value;
    if (!s) { const t=new Date(); s=formatDateForStore(t); sInput.value=s; }
    const [y,m,d]=s.split("-");
    const base = new Date(+y,+m-1,+d);
    const end  = new Date(base.getTime());
    end.setDate(end.getDate()+Number(days));
    eInput.value = formatDateForStore(end);
    updateAssignDatePreview();
  }

  function createAssignments() {
    const tids = getSelectedTeacherIds();
    const studs = getSelectedStudents();
    const s = document.getElementById("assignStart").value;
    const e = document.getElementById("assignEnd").value;

    if (!tids.length || !studs.length || !s || !e) { alert("LÃ¼tfen Ã¶ÄŸretmen, Ã¶ÄŸrenci ve tarih aralÄ±ÄŸÄ± seÃ§iniz."); return; }
    if (e < s) { alert("BitiÅŸ tarihi baÅŸlangÄ±Ã§tan Ã¶nce olamaz."); return; }

    let added=0;
    tids.forEach(tid=>{
      const t=teachers.find(x=>x.id===tid); if(!t) return;
      studs.forEach(st=>{
        const exists = assignments.some(a => a.teacherId===tid && a.schoolNumber===st.okulNo && a.startDate===s && a.endDate===e);
        if (exists) return;
        assignments.push({
          id: uid(),
          teacherId: tid,
          teacherName: t.ad,
          teacherBranch: t.brans,
          studentFirstName: st.isim,
          studentLastName: st.soyisim,
          gender: st.cinsiyet,
          class: st.sinif,
          schoolNumber: st.okulNo,
          parentFirstName: st.veliAdi,
          parentLastName: st.veliSoyadi,
          parentPhone: st.veliTel,
          startDate: s,
          endDate: e,
          called: false,
          note: ""
        });
        added++;
      });
    });
    if (!added) alert("SeÃ§ilen kriterlere uygun yeni atama eklenemedi (zaten ekli olabilir).");
    else { 
      renderAssignmentsTable(); 
      document.getElementById("assignmentsBody").scrollIntoView({behavior: "smooth", block: "end"});
    }
  }

  function removeAssignmentById(id) {
    if(!confirm("Bu atama listeden silinsin mi?")) return;
    assignments = assignments.filter(a=>a.id!==id);
    renderAssignmentsTable();
  }

  function syncReportBackToAssignments() {
    Array.from(document.querySelectorAll(".report-called")).forEach(cb=>{
      const id = cb.getAttribute("data-assignment-id");
      const a = assignments.find(x=>x.id===id);
      if (a) a.called = cb.checked;
    });
    Array.from(document.querySelectorAll(".note-cell")).forEach(t=>{
      const id = t.getAttribute("data-assignment-id");
      const a = assignments.find(x=>x.id===id);
      if (a) a.note = t.value;
    });
  }

  document.getElementById("reloadDataBtn").addEventListener("click", loadAllData);
  document.getElementById("classFilter").addEventListener("change", renderStudentsTable);
  document.getElementById("assignStart").addEventListener("change", updateAssignDatePreview);
  document.getElementById("assignEnd").addEventListener("change", updateAssignDatePreview);
  document.querySelectorAll("button[data-quick]").forEach(btn=>{
    btn.addEventListener("click", ()=>applyQuickRange(btn.getAttribute("data-quick")));
  });
  document.getElementById("selectAllStudentsBtn").addEventListener("click", ()=>{
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=true);
    document.getElementById("allRowCheckbox").checked=true;
  });
  document.getElementById("clearSelectionBtn").addEventListener("click", ()=>{
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=false);
    document.getElementById("allRowCheckbox").checked=false;
  });
  document.getElementById("allRowCheckbox").addEventListener("change",e=>{
    const c=e.target.checked;
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=c);
  });
  document.getElementById("assignBtn").addEventListener("click", createAssignments);
  document.getElementById("assignmentsBody").addEventListener("click",e=>{
    const btn=e.target.closest("button[data-del-id]");
    if(btn) removeAssignmentById(btn.getAttribute("data-del-id"));
  });
  
  document.getElementById("saveAssignmentsBtn").addEventListener("click", async()=>{
    syncReportBackToAssignments();
    await saveAssignmentsToFirebase();
  });
  document.getElementById("deleteAssignmentsBtn").addEventListener("click", deleteAllAssignmentsInFirebase);
  document.getElementById("clearLocalListBtn").addEventListener("click", clearLocalList);
  
  document.getElementById("printReportsBtn").addEventListener("click", ()=>{
    syncReportBackToAssignments();
    renderReports();
    // TarayÄ±cÄ±nÄ±n render etmesi iÃ§in ufak bir gecikme
    setTimeout(() => {
        window.print();
    }, 500);
  });

  loadAllData();
</script>
</body>
</html>
