<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ã–ÄŸrenci-Ã–ÄŸretmen Atama ve Arama Raporu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      background: #f0f2f5;
    }
    body {
      margin: 0;
      padding: 0 16px 40px;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 8px;
      color: #1a202c;
    }
    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      padding: 20px;
      margin-top: 20px;
      border: 1px solid #e2e8f0;
    }
    .flex {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .col {
      flex: 1 1 300px;
      min-width: 250px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: #4a5568;
    }
    select, input[type="date"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e0;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    select:focus, input:focus, textarea:focus {
      border-color: #3182ce;
      outline: none;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }
    select[multiple] {
      height: 160px;
    }
    button {
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #3182ce;
      color: white;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    button:hover {
      background: #2c5282;
    }
    button.secondary {
      background: #edf2f7;
      color: #2d3748;
    }
    button.secondary:hover {
      background: #e2e8f0;
    }
    button.danger {
      background: #e53e3e;
    }
    button.danger:hover {
      background: #c53030;
    }
    button.warning {
      background: #dd6b20;
      color: white;
    }
    button.warning:hover {
      background: #c05621;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /*
     * Atama eylem dÃ¼ÄŸmelerinin dÃ¼zeni (Listeyi Temizle, Firebase'e Kaydet,
     * Firebase'i Sil, RaporlarÄ± YazdÄ±r).  Bu Ã¶zel kapsayÄ±cÄ±, bÃ¼yÃ¼k
     * ekranlarda tÃ¼m dÃ¼ÄŸmeleri yatayda tutar; kÃ¼Ã§Ã¼k ekranlarda ise
     * dÃ¼ÄŸmeler iki sÃ¼tun halinde kÄ±rÄ±lÄ±r ve yazÄ±/kenar boÅŸluklarÄ±
     * kÃ¼Ã§Ã¼ltÃ¼lÃ¼r.  KullanÄ±cÄ±nÄ±n isteÄŸi Ã¼zerine bu dÃ¼zen yalnÄ±zca
     * mobil gÃ¶rÃ¼nÃ¼mde uygulanÄ±r.
     */
    .assign-button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    .assign-button-group button {
      flex: 1 1 auto;
    }
    @media (max-width: 600px) {
      .assign-button-group button {
        flex: 1 1 calc(50% - 10px);
        font-size: 0.8rem;
        padding: 8px 12px;
        white-space: nowrap;
      }
    }
    .pill-group button {
      padding: 6px 14px;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 10px 12px;
      text-align: left;
    }
    thead {
      background: #f7fafc;
    }
    th {
      font-weight: 600;
      color: #4a5568;
    }
    
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #ebf8ff;
      color: #2b6cb0;
      margin-left: 4px;
      font-weight: normal;
    }
    .muted {
      font-size: 0.85rem;
      color: #718096;
    }
    .date-preview {
      font-size: 0.85rem;
      margin-top: 6px;
      color: #4a5568;
      font-weight: 600;
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: #2d3748;
    }

    /* Telefon bilgisini belirginleÅŸtirmek iÃ§in (ekran + yazdÄ±rma) */
    .phone-pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5e0;
      background: #f8fafc;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    /* YENÄ°: Ä°statistik KutularÄ± (Profesyonel GÃ¶rÃ¼nÃ¼m Ä°Ã§in) */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    .stat-box {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .stat-label {
      font-size: 0.85rem;
      color: #718096;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 1.2rem;
      color: #2d3748;
      font-weight: 700;
    }

    /* RAPOR KARTI TASARIMI */
    .report-card {
      border: 1px solid #e2e8f0;
      border-radius: 0;
      padding: 0;
      margin-top: 30px;
      background: #fff;
      page-break-inside: auto !important;
    }
    
    .report-header-box {
      background: #f7fafc;
      padding: 15px 20px;
      border-bottom: 2px solid #3182ce;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .report-header-info h3 {
      margin: 0;
      font-size: 1.4rem;
      color: #2c5282;
    }
    .report-header-meta {
      display: flex;
      gap: 15px;
      margin-top: 5px;
      font-size: 0.9rem;
      color: #4a5568;
    }

    textarea.note-cell {
      width: 100%;
      min-height: 40px;
      resize: vertical;
      font-size: 0.85rem;
      border: 1px dashed #cbd5e0;
      background: #fffaf0;
      padding: 8px;
      margin-top: 4px;
      font-family: 'Segoe UI', sans-serif;
    }

    .info-block {
      font-size: 0.8rem;
      color: #718096;
      margin-top: 6px;
    }

    /* Alt Not TasarÄ±mÄ± */
    .footer-note {
      margin: 15px;
      padding: 12px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 600;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      color: #475569;
      background-color: #f8fafc;
    }

    .report-page-title {
      display: none;
    }

    /* YAZDIRMA Ä°Ã‡Ä°N SATIR GRUPLAMA */
    .student-print-block {
      page-break-inside: avoid !important;
      break-inside: avoid !important;
      border-bottom: 4px solid #e2e8f0;
    }

    /* YazdÄ±rma Ã¶zel stilleri */
    #reportContainer {
      display: none;
    }
    #printTitle {
      display: none;
    }

    
@media print {
      @page {
        margin: 4mm 6mm; /* Daha geniÅŸ iÃ§erik alanÄ± */
        size: A4;
      }
      body {
        background: #fff;
        padding: 0;
        font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        color: #000;
        font-size: 9pt;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      /* Gereksizleri Gizle */
      .no-print, .assign-button-group, button, 
      .app-shell > h1, .app-shell > p, .card:not(.report-card) {
        display: none !important;
      }

      #reportContainer { display: block; width: 100%; }
      #printTitle { display: none !important; }
      .report-page-title { display: block !important; }

      .report-page-title {
        text-align: center;
        font-size: 16pt;
        font-weight: 900;
        letter-spacing: 0.8px;
        margin: 0 0 10px 0;
        padding: 8px 10px;
        border: 2px solid #000;
        border-radius: 8px;
        background: #f5f5f5 !important;
      }
      .report-page-subtitle {
        text-align: center;
        font-size: 9pt;
        font-weight: 700;
        margin-top: -6px;
        margin-bottom: 12px;
      }

      /* Ana Rapor KapsayÄ±cÄ±sÄ± */
      .report-card {
        border: none;
        box-shadow: none;
        margin: 0;
        padding: 0;
        page-break-after: always;
      }
      .report-card:last-child { page-break-after: auto; }

      /* Rapor BaÅŸlÄ±ÄŸÄ± */
      .report-header-box {
        border: 2px solid #333;
        border-radius: 6px;
        margin-bottom: 10px;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f0f0f0 !important;
      }
      .report-header-info h3 {
        margin: 0;
        font-size: 14pt;
        font-weight: 800;
        text-transform: uppercase;
        color: #000 !important;
      }
      .report-header-meta { font-size: 9pt; font-weight: 600; color: #000 !important; }

      /* --- KART TASARIMI --- */
      .student-card-grid {
        display: flex;
        flex-direction: column;
        gap: 6px; /* Kartlar arasÄ± boÅŸluk */
      }

      .student-card {
        border: 1px solid #888;
        border-radius: 5px;
        overflow: hidden;
        page-break-inside: avoid; /* KartÄ±n sayfalar arasÄ± bÃ¶lÃ¼nmesini engeller */
        break-inside: avoid;
        display: flex;
        flex-direction: column;
      }

      /* KartÄ±n Ãœst KÄ±smÄ±: Bilgiler */
      .card-top {
        background-color: #f4f6f8 !important; /* Hafif gri zemin */
        padding: 8px 12px;
        border-bottom: 1px solid #ccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .info-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
      .st-index { 
        background: #333 !important;
        color: #fff !important;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        text-align: center;
        line-height: 18px;
        font-size: 7pt;
        font-weight: bold;
        flex: 0 0 auto;
      }
      .st-name { font-weight: 800; font-size: 10pt; color: #000; }
      .st-class { 
        border: 1px solid #000;
        padding: 1px 6px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 8pt;
      }
      .st-parent { font-size: 9pt; color: #333; }
      .st-phone { font-family: 'Courier New', monospace; font-weight: 700; }
      .phone-pill { border: 1px solid #000 !important; background: #fff !important; }

      /* KartÄ±n Alt KÄ±smÄ±: Not AlanÄ± */
      .card-bottom {
        padding: 0;
        display: flex;
        min-height: 48px; /* GÃ¶rÃ¼ÅŸme notlarÄ± iÃ§in daha geniÅŸ alan */
      }

      .note-area {
        flex: 1;
        padding: 12px 12px 8px 12px; /* Ã¼stte etiket iÃ§in pay */
        position: relative;
      }

      .note-area::after {
        content: "GÃ–RÃœÅME NOTLARI:";
        position: absolute;
        top: 2px;
        left: 10px;
        font-size: 7pt;
        color: #999;
        text-transform: uppercase;
      }

      .note-area textarea.note-input {
        width: 100%;
        height: 100%;
        min-height: 34px;
        border: none;
        outline: none;
        resize: none;
        background: transparent;
        font-family: inherit;
        font-size: 9pt;
        color: #000;
        padding: 0;
        margin: 0;
        box-sizing: border-box;
      }

      .action-area {
        width: 40px;
        border-left: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        flex: 0 0 auto;
      }

      /* Checkbox stilleri */
      input[type="checkbox"] {
        width: 16px;
        height: 16px;
        border: 2px solid #333;
        appearance: none;
        -webkit-appearance: none;
        border-radius: 3px;
        display: inline-block;
      }
      input[type="checkbox"]:checked { background-color: #333; }

      .footer-note {
        margin-top: 10px;
        text-align: center;
        font-size: 8pt;
        border-top: 2px dashed #999;
        padding-top: 5px;
        background: transparent !important;
        color: #000 !important;
      }
    }

    /*
     * Responsive tweaks for small screens
     *
     * The desktop layout uses flexible rows and columns that work well on wide
     * screens, but on narrow mobile devices some of the controls (especially
     * buttons and form fields) can wrap awkwardly or overflow.  To make the
     * interface easier to use on phones, switch the flex layouts to vertical
     * stacking, allow elements to take up the full width of the screen and
     * wrap button groups when the viewport is less than 600px wide.  This
     * improves readability and prevents the â€œkaymaâ€ (shifting) of buttons the
     * user reported when viewing the page on a mobile device.
     */
    @media (max-width: 600px) {
      /* Stack flex containers vertically */
      .flex, .flex-between {
        flex-direction: column;
        align-items: stretch;
      }

      /* Ensure children of flex containers span the full width */
      .flex > .col,
      .flex-between > * {
        flex: 1 1 auto;
        min-width: 100%;
      }

      /* Fullâ€‘width buttons for easier tapping on mobile */
      button {
        width: 100%;
        margin-top: 8px;
      }

      /* Wrap pill group buttons gracefully */
      .pill-group {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .pill-group button {
        flex: 1 1 auto;
      }

      /* Tweak stat boxes grid for smaller screens */
      .stat-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }

      /* Reduce table font size slightly to fit more content */
      table {
        font-size: 0.8rem;
      }

      /* Adjust card padding for compactness */
      .card {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <h1 class="no-print">Ã–ÄŸrenci â€“ Ã–ÄŸretmen Atama ve Arama Takip Sistemi</h1>
  <p style="text-align:center" class="muted no-print">
    Veriler Google Sheets'ten Ã§ekilir, atamalar Firebase Realtime Database'e kaydedilir.
  </p>
  <h1 id="printTitle" style="display:none">Ã–ÄŸretmen Arama Takip Sistemi</h1>

  <div class="card no-print">
    <div class="flex-between">
      <div>
        <div class="section-title">1. Veri KaynaÄŸÄ±</div>
        <div class="muted">
          Listeler Google Sheets Ã¼zerinden Ã§ekilir.
        </div>
      </div>
      <div>
        <button id="reloadDataBtn">Verileri Yeniden YÃ¼kle</button>
      </div>
    </div>
    
    <div class="stat-grid">
      <div class="stat-box">
        <span class="stat-label">Ã–ÄŸrenci Durumu</span>
        <span id="studentStatus" class="stat-value">YÃ¼kleniyor...</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Ã–ÄŸretmen Durumu</span>
        <span id="teacherStatus" class="stat-value">YÃ¼kleniyor...</span>
      </div>
    </div>
  </div>

  <div class="card no-print">
    <div class="section-title">2. Atama Ä°ÅŸlemleri</div>
    <div class="flex">
      <div class="col">
        <label for="classFilter">SÄ±nÄ±f SeÃ§iniz <span class="badge">Ã‡oklu</span></label>
        <select id="classFilter" multiple></select>
        <div class="info-block">Birden fazla sÄ±nÄ±f seÃ§mek iÃ§in CTRL tuÅŸuna basÄ±lÄ± tutun.</div>
      </div>
      <div class="col">
        <label for="teacherSelect">Ã–ÄŸretmen SeÃ§iniz <span class="badge">Ã‡oklu</span></label>
        <select id="teacherSelect" multiple></select>
        <div class="info-block">Birden fazla seÃ§im iÃ§in CTRL tuÅŸuna basÄ±lÄ± tutun.</div>
      </div>
      <div class="col">
        <label>Arama Tarih AralÄ±ÄŸÄ±</label>
        <div class="flex" style="gap:8px">
          <div style="flex:1"><input type="date" id="assignStart" /></div>
          <div style="flex:1"><input type="date" id="assignEnd" /></div>
        </div>
        <div class="pill-group" style="margin-top:8px">
          <button type="button" class="secondary" data-quick="7">+1 Hafta</button>
          <button type="button" class="secondary" data-quick="14">+2 Hafta</button>
          <button type="button" class="secondary" data-quick="21">+3 Hafta</button>
          <button type="button" class="secondary" data-quick="28">+4 Hafta</button>
        </div>
        <div id="assignDatePreview" class="date-preview">AralÄ±k seÃ§ilmedi.</div>
      </div>
    </div>

    <div class="flex-between" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
      <div>
        <button id="selectAllStudentsBtn" class="secondary">TÃ¼m SÄ±nÄ±fÄ± SeÃ§</button>
        <button id="clearSelectionBtn" class="secondary">SeÃ§imi KaldÄ±r</button>
      </div>
      <div>
        <button id="assignBtn">âœ… AtamayÄ± OluÅŸtur</button>
      </div>
    </div>

    <h3 style="margin-top:20px; font-size:1.1rem; color:#2d3748;">Ã–ÄŸrenci Listesi</h3>
    <div class="muted">SÄ±ralama: Ä°sim (A-Z) > Okul No</div>
    <div style="max-height:300px; overflow:auto; margin-top:8px; border:1px solid #e2e8f0; border-radius:6px;">
      <table>
        <thead>
          <tr>
            <th style="width:40px; text-align:center;"><input type="checkbox" id="allRowCheckbox" /></th>
            <th>Ä°sim</th>
            <th>Soyisim</th>
            <th>Cinsiyet</th>
            <th>SÄ±nÄ±f</th>
            <th>Okul No</th>
            <th>Veli AdÄ±</th>
            <th>Veli SoyadÄ±</th>
            <th>ğŸ“ Veli Tel</th>
          </tr>
        </thead>
        <tbody id="studentsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card no-print">
    <div class="flex-between">
      <div>
        <div class="section-title">3. YapÄ±lan Atamalar & Rapor</div>
        <div class="muted">OluÅŸturulan listeyi kontrol edin ve yazdÄ±rÄ±n.</div>
      </div>
      <!--
        The four action buttons (clear, save, delete, print) are laid out in a horizontal
        row on larger screens.  On small mobile screens, however, they overflow the
        viewport.  To solve this without affecting desktop layout, wrap the buttons
        in a container with a dedicated class (assign-button-group) and move the
        existing inline flex styles into the stylesheet.  Additional responsive
        CSS further down the file will cause the buttons to wrap into two columns
        when the viewport is narrow, making them easier to tap on phones.
      -->
      <div class="assign-button-group">
        <button id="clearLocalListBtn" class="warning">ğŸ§¹ Listeyi Temizle</button>
        <button id="saveAssignmentsBtn">ğŸ’¾ Firebase'e Kaydet</button>
        <button id="deleteAssignmentsBtn" class="danger">ğŸ—‘ï¸ Firebase'i Sil</button>
        <button id="printReportsBtn">ğŸ–¨ï¸ RaporlarÄ± YazdÄ±r</button>
      </div>
    </div>

    <div style="max-height:300px; overflow:auto; margin-top:15px; border:1px solid #e2e8f0; border-radius:6px;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ã–ÄŸretmen</th>
            <th>BranÅŸ</th>
            <th>Ä°sim</th>
            <th>Soyisim</th>
            <th>SÄ±nÄ±f</th>
            <th>No</th>
            <th>Veli</th>
            <th>ğŸ“ Tel</th>
            <th>Tarih</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="assignmentsBody"></tbody>
      </table>
    </div>
  </div>

  <div id="reportContainer"></div>
</div>

<script type="module">
  /* SABÄ°TLER */
  const STUDENT_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi/gviz/tq?tqx=out:csv&sheet=2025-2026";
  const TEACHER_SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg/export?format=csv&gid=0";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
    authDomain: "odevfeno.firebaseapp.com",
    databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "odevfeno",
    storageBucket: "odevfeno.firebasestorage.app",
    messagingSenderId: "662757516934",
    appId: "1:662757516934:web:0042188832f63deb6fd307",
    measurementId: "G-4Q99NQRB38"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const ASSIGNMENTS_PATH = "assignments";

  let students = [];
  let teachers = [];
  let assignments = [];

  /* YARDIMCI FONKSÄ°YONLAR */
  function detectSeparator(line) {
    const comma = (line.match(/,/g) || []).length;
    const semi = (line.match(/;/g) || []).length;
    return semi > comma ? ";" : ",";
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];
    const sep = detectSeparator(lines[0]);
    const rows = [];
    for (const line of lines) {
      const row = [];
      let cur = "";
      let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i + 1] === '"') {
            cur += '"'; i++;
          } else inQ = !inQ;
        } else if (ch === sep && !inQ) {
          row.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      row.push(cur);
      rows.push(row.map(c => c.trim()));
    }
    return rows;
  }

  function findColumnIndex(headerRow, expectedHeader) {
    const target = expectedHeader.replace(/\*/g, "").trim();
    for (let i = 0; i < headerRow.length; i++) {
      const cell = (headerRow[i] || "").replace(/\*/g, "").trim();
      if (cell === target) return i;
    }
    return -1;
  }

  function toDisplayDateFromISO(iso) {
    if (!iso) return "";
    const [y, m, d] = iso.split("-");
    return `${d}.${m}.${y}`;
  }

  function formatDateForStore(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function normalizePhone(raw) {
    const s = (raw ?? "").toString().trim();
    if (!s) return "";
    // Keep only digits
    let d = s.replace(/\D/g, "");
    // Convert +90 / 90XXXXXXXXXX to 0XXXXXXXXXX
    if (d.length === 12 && d.startsWith("90")) d = "0" + d.slice(2);
    // If user entered 10 digits starting with 5 (typical GSM), prefix 0
    if (d.length === 10 && d.startsWith("5")) d = "0" + d;
    // If already starts with 0 and length is 11, keep as is
    return d;
  }

  function formatPhoneDisplay(raw) {
    const d = normalizePhone(raw);
    if (!d) return (raw ?? "").toString().trim();
    // Format: 0XXX XXX XX XX when length is 11
    if (d.length === 11 && d.startsWith("0")) {
      return `${d.slice(0,4)} ${d.slice(4,7)} ${d.slice(7,9)} ${d.slice(9,11)}`;
    }
    return d;
  }

  function normalizeStudentLike(obj) {
    return {
      cls: (obj.sinif || obj.class || "").toString(),
      first: (obj.isim || obj.studentFirstName || "").toString(),
      last: (obj.soyisim || obj.studentLastName || "").toString(),
      no: (obj.okulNo || obj.schoolNumber || "").toString()
    };
  }

  function compareClassCode(a, b) {
    // Class codes like "6A", "5D" - simple locale compare is adequate
    return a.localeCompare(b, 'tr', { numeric: true, sensitivity: 'base' });
  }

  function sortStudentLike(a, b, sortByClass) {
    const A = normalizeStudentLike(a);
    const B = normalizeStudentLike(b);

    if (sortByClass) {
      const c = compareClassCode(A.cls, B.cls);
      if (c !== 0) return c;
    }

    const fn = A.first.toLocaleLowerCase('tr').localeCompare(B.first.toLocaleLowerCase('tr'), 'tr');
    if (fn !== 0) return fn;

    const ln = A.last.toLocaleLowerCase('tr').localeCompare(B.last.toLocaleLowerCase('tr'), 'tr');
    if (ln !== 0) return ln;

    const numA = parseInt(A.no, 10);
    const numB = parseInt(B.no, 10);
    if (!isNaN(numA) && !isNaN(numB)) return numA - numB;

    return A.no.localeCompare(B.no, 'tr', { numeric: true, sensitivity: 'base' });
  }

  function listHasMultipleClasses(list) {
    const set = new Set();
    (list || []).forEach(x => {
      const cls = (x.sinif || x.class || "").toString().trim();
      if (cls) set.add(cls);
    });
    return set.size > 1;
  }


  const unique = arr => Array.from(new Set(arr));
  const uid = () => "a_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  const studentKey = (s) => `${s.sinif}||${s.okulNo}||${s.isim}||${s.soyisim}`;
  const assignmentStudentKey = (a) => (a.studentKey || `${a.class}||${a.schoolNumber}||${a.studentFirstName}||${a.studentLastName}`);
  const setText = (id, t) => { const el = document.getElementById(id); if (el) el.textContent = t; };

  /* VERÄ° Ã‡EKME */
  async function loadStudents() {
    setText("studentStatus", "YÃ¼kleniyor...");
    const res = await fetch(STUDENT_SHEET_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) { setText("studentStatus","Veri yok"); return; }

    const header = rows[0];
    const idxIsim       = findColumnIndex(header, "Ä°sim");
    const idxSoyisim    = findColumnIndex(header, "Soyisim*");
    const idxCinsiyet   = findColumnIndex(header, "Cinsiyet*");
    const idxSinif      = findColumnIndex(header, "SÄ±nÄ±f");
    const idxOkulNo     = findColumnIndex(header, "Okul NumarasÄ±");
    const idxVeliAdi    = findColumnIndex(header, "Veli AdÄ±");
    const idxVeliSoyad  = findColumnIndex(header, "Veli SoyadÄ±");
    const idxVeliTel    = findColumnIndex(header, "Veli Telefon");

    const required = [idxIsim, idxSoyisim, idxCinsiyet, idxSinif, idxOkulNo];
    if (required.some(i => i === -1)) {
      setText("studentStatus","HatalÄ± BaÅŸlÄ±klar");
      return;
    }

    students = rows.slice(1)
      .filter(r => r[idxIsim] && r[idxSinif])
      .map(r => ({
        isim: r[idxIsim] || "",
        soyisim: r[idxSoyisim] || "",
        cinsiyet: r[idxCinsiyet] || "",
        sinif: r[idxSinif] || "",
        okulNo: r[idxOkulNo] || "",
        veliAdi:    idxVeliAdi    !== -1 ? (r[idxVeliAdi]    || "") : "",
        veliSoyadi: idxVeliSoyad !== -1 ? (r[idxVeliSoyad] || "") : "",
        veliTel:    idxVeliTel    !== -1 ? (normalizePhone(r[idxVeliTel] || "") || (r[idxVeliTel] || "")) : "",
        key: ""
      }));

    // Ã–ÄŸrenci anahtarÄ±: sÄ±nÄ±f + okul no + ad + soyad (aynÄ± okul numarasÄ± farklÄ± sÄ±nÄ±flarda tekrar ederse karÄ±ÅŸmayÄ± engeller)
    students.forEach(s => { s.key = studentKey(s); });

    const counts = {};
    students.forEach(s=>{ const c=(s.sinif||"").toString().trim(); if(!c) return; counts[c]=(counts[c]||0)+1; });
    const breakdown = Object.keys(counts).sort(compareClassCode).map(k=>`${k} ${counts[k]} KiÅŸi`).join(" â€¢ ");
    setText("studentStatus", breakdown ? `${breakdown} (Toplam ${students.length})` : `${students.length} Ã–ÄŸrenci`);
    fillClassFilter();
    renderStudentsTable();
  }

  async function loadTeachers() {
    setText("teacherStatus", "YÃ¼kleniyor...");
    const res = await fetch(TEACHER_SHEET_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) { setText("teacherStatus","Veri yok"); return; }
    const header = rows[0];
    const idxId    = findColumnIndex(header, "ID");
    const idxAd    = findColumnIndex(header, "OGRETMEN_ADI");
    const idxBrans = findColumnIndex(header, "BRANS");

    teachers = rows.slice(1)
      .filter(r => r[idxAd])
      .map(r => ({
        id:    idxId    !== -1 ? (r[idxId]    || "") : "",
        ad:    idxAd    !== -1 ? (r[idxAd]    || "") : "",
        brans: idxBrans !== -1 ? (r[idxBrans] || "") : ""
      }));

    setText("teacherStatus", `${teachers.length} Ã–ÄŸretmen`);
    fillTeacherSelect();
  }

  async function loadAssignmentsFromFirebase() {
    try {
      const snap = await get(ref(db, ASSIGNMENTS_PATH));
      if (snap.exists()) {
        const val = snap.val();
        assignments = Array.isArray(val) ? val.filter(Boolean) : Object.values(val || {});
      } else assignments = [];
      renderAssignmentsTable();
    } catch (e) { console.error(e); }
  }

  async function loadAllData() {
    try {
      await Promise.all([loadStudents(), loadTeachers(), loadAssignmentsFromFirebase()]);
    } catch (e) {
      console.error(e);
      alert("Veriler yÃ¼klenirken hata oluÅŸtu.");
    }
  }

  /* EKRAN DOLDURMA */
  function fillClassFilter() {
    const sel = document.getElementById("classFilter");
    const siniflar = unique(students.map(s => s.sinif)).sort();
    sel.innerHTML = "";
    siniflar.forEach(s => {
      const o = document.createElement("option");
      o.value = s; o.textContent = s;
      sel.appendChild(o);
    });

    // Ä°lk yÃ¼klemede en az 1 sÄ±nÄ±f seÃ§ili olsun
    if (sel.options.length && sel.selectedOptions.length === 0) {
      sel.options[0].selected = true;
    }
  }

  const getSelectedClasses = () =>
    Array.from(document.getElementById("classFilter").selectedOptions).map(o => o.value);

  function fillTeacherSelect() {
    const sel = document.getElementById("teacherSelect");
    sel.innerHTML = "";
    teachers.forEach(t => {
      const o = document.createElement("option");
      o.value = t.id;
      o.textContent = `${t.ad} (${t.brans})`;
      sel.appendChild(o);
    });
  }

  function renderStudentsTable() {
    const tbody = document.getElementById("studentsBody");
    const selectedClasses = getSelectedClasses();
    if (!selectedClasses.length) { tbody.innerHTML = ""; return; }

    let list = students.filter(s => selectedClasses.includes(s.sinif));
    list.sort((a,b)=>sortStudentLike(a,b, (typeof selectedClasses!=="undefined" && selectedClasses.length>1) || listHasMultipleClasses(list)));

    tbody.innerHTML = "";
    list.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:center;"><input type="checkbox" class="student-checkbox" data-skey="${s.key}"></td>
        <td>${s.isim}</td>
        <td>${s.soyisim}</td>
        <td>${s.cinsiyet}</td>
        <td>${s.sinif}</td>
        <td>${s.okulNo}</td>
        <td>${s.veliAdi}</td>
        <td>${s.veliSoyadi}</td>
        <td>${formatPhoneDisplay(s.veliTel)}</td>
      `;
      tbody.appendChild(tr);
    });

    // Liste deÄŸiÅŸtiÄŸi iÃ§in "tÃ¼mÃ¼nÃ¼ seÃ§" Ã¼st kutusunu sÄ±fÄ±rla
    const allCb = document.getElementById("allRowCheckbox");
    if (allCb) allCb.checked = false;
  }

  function renderAssignmentsTable() {
    const tbody = document.getElementById("assignmentsBody");
    tbody.innerHTML = "";
    
    assignments.sort((a,b)=>sortStudentLike(a,b, listHasMultipleClasses(assignments)));

    assignments.forEach((a,i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${a.teacherName}</td>
        <td>${a.teacherBranch}</td>
        <td>${a.studentFirstName}</td>
        <td>${a.studentLastName}</td>
        <td>${a.class}</td>
        <td>${a.schoolNumber}</td>
        <td>${a.parentFirstName} ${a.parentLastName}</td>
        <td>ğŸ“ ${formatPhoneDisplay(a.parentPhone)}</td>
        <td>${toDisplayDateFromISO(a.startDate)}<br>${toDisplayDateFromISO(a.endDate)}</td>
        <td><button type="button" class="danger" style="padding:4px 8px; font-size:0.8rem" data-del-id="${a.id}">Sil</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

    /* RAPOR OLUÅTURMA (KARTLI MODERN SÄ°STEM) */

function renderReports() {
  const cont = document.getElementById("reportContainer");
  cont.innerHTML = "";

  // YazdÄ±rma baÅŸlÄ±ÄŸÄ± (ilk sayfanÄ±n en Ã¼stÃ¼)
  const pageTitle = document.createElement("div");
  pageTitle.className = "report-page-title";
  pageTitle.textContent = "VELÄ° ARAMA LÄ°STESÄ°";
  cont.appendChild(pageTitle);

  if (!assignments.length) {
    cont.innerHTML += "<p class='muted'>Herhangi bir atama yok.</p>";
    return;
  }

  const filtered = assignments.slice();
  if (!filtered.length) return;

  // Gruplama
  const groups = {};
  filtered.forEach(a => {
    if (!groups[a.teacherId]) groups[a.teacherId] = [];
    groups[a.teacherId].push(a);
  });

  const teacherIds = Object.keys(groups);

  // UyarÄ± notu (KullanÄ±cÄ±nÄ±n ilk gÃ¶nderdiÄŸi orijinal metinle birebir aynÄ± olmalÄ±dÄ±r.)
  // Not: Bu sohbet iÃ§inde orijinal metin bulunmadÄ±ÄŸÄ± iÃ§in mevcut metin korunmuÅŸtur; gerekirse aÅŸaÄŸÄ±daki sabit deÄŸiÅŸtirilebilir.
  const WARNING_NOTE = "ğŸ“Œ Not: Bu liste tamamlandÄ±ÄŸÄ±nda lÃ¼tfen ilgili zÃ¼mre baÅŸkanÄ±na zamanÄ±nda teslim ediniz.";

  teacherIds.forEach((tid) => {
    const list = groups[tid];
    const tName = list[0].teacherName;
    const tBranch = list[0].teacherBranch;
    const minStart = list.reduce((m,a)=>!m||a.startDate < m ? a.startDate : m, null);
    const maxEnd = list.reduce((m,a)=>!m||a.endDate > m ? a.endDate : m, null);

    // SÄ±ralama
    list.sort((a,b)=>sortStudentLike(a,b, listHasMultipleClasses(list)));

    const cardWrapper = document.createElement("div");
    cardWrapper.className = "report-card";

    // 1. BaÅŸlÄ±k AlanÄ±
    const headerHtml = `
      <div class="report-header-box">
        <div class="report-header-info">
          <h3>${tName}</h3>
          <div style="font-size:10pt; font-weight:normal; margin-top:2px;">${tBranch}</div>
        </div>
        <div class="report-header-meta" style="text-align:right">
          <div>${list.length} Ã–ÄŸrenci AtandÄ±</div>
          <div>${toDisplayDateFromISO(minStart)} â€“ ${toDisplayDateFromISO(maxEnd)}</div>
        </div>
      </div>
    `;

    // 2. Ã–ÄŸrenci KartlarÄ± Konteyneri
    const grid = document.createElement("div");
    grid.className = "student-card-grid";

    list.forEach((a, i) => {
      const studentCard = document.createElement("div");
      studentCard.className = "student-card";

      studentCard.innerHTML = `
        <div class="card-top">
          <div class="info-group">
            <span class="st-index">${i+1}</span>
            <span class="st-class">${a.class}</span>
            <span class="st-name">${a.studentFirstName} ${a.studentLastName}</span>
            <small style="color:#666">(${a.schoolNumber})</small>
          </div>
          <div class="info-group" style="font-size:9pt;">
            <span class="st-parent">Veli: <strong>${a.parentFirstName} ${a.parentLastName}</strong></span>
            <span class="st-phone"><span class="phone-pill">ğŸ“ ${formatPhoneDisplay(a.parentPhone)}</span></span>
          </div>
        </div>
        <div class="card-bottom">
          <div class="note-area">
            <textarea class="note-input" data-assignment-id="${a.id}">${a.note || ""}</textarea>
          </div>
          <div class="action-area">
             <input type="checkbox" class="report-called" data-assignment-id="${a.id}" ${a.called ? "checked" : ""}>
          </div>
        </div>
      `;
      grid.appendChild(studentCard);
    });

    cardWrapper.innerHTML = headerHtml; // BaÅŸlÄ±ÄŸÄ± ekle
    cardWrapper.appendChild(grid); // KartlarÄ± ekle

    const footerNote = document.createElement("div");
    footerNote.className = "footer-note";
    footerNote.textContent = WARNING_NOTE;
    cardWrapper.appendChild(footerNote);

    cont.appendChild(cardWrapper);
  });
}


/* Ä°ÅLEVLER */
  async function saveAssignmentsToFirebase() {
    try {
      await set(ref(db, ASSIGNMENTS_PATH), assignments);
      alert("TÃ¼m atamalar veritabanÄ±na kaydedildi.");
    } catch (e) {
      console.error(e);
      alert("Kaydetme hatasÄ±: " + e.message);
    }
  }

  async function deleteAllAssignmentsInFirebase() {
    if (!confirm("âš ï¸ DÄ°KKAT: VeritabanÄ±ndaki TÃœM atamalar silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?")) return;
    try {
      await remove(ref(db, ASSIGNMENTS_PATH));
      assignments = [];
      renderAssignmentsTable();
      document.getElementById("reportContainer").innerHTML="";
      alert("VeritabanÄ± temizlendi.");
    } catch (e) { console.error(e); alert("Silme hatasÄ±."); }
  }

  function clearLocalList() {
    if (!confirm("Ekrandaki liste temizlensin mi? (VeritabanÄ±ndan silinmez, sadece gÃ¶rÃ¼nÃ¼m sÄ±fÄ±rlanÄ±r).")) return;
    assignments = [];
    renderAssignmentsTable();
    document.getElementById("reportContainer").innerHTML="";
  }

  const getSelectedTeacherIds = () => Array.from(document.getElementById("teacherSelect").selectedOptions).map(o => o.value);
  
  function getSelectedStudents() {
    const keys = Array.from(document.querySelectorAll(".student-checkbox:checked"))
      .map(cb => cb.getAttribute("data-skey"));
    return students.filter(s => keys.includes(s.key));
  }

  function updateAssignDatePreview() {
    const s = document.getElementById("assignStart").value;
    const e = document.getElementById("assignEnd").value;
    const el = document.getElementById("assignDatePreview");
    if (!s || !e) { el.textContent="AralÄ±k seÃ§ilmedi."; return; }
    el.textContent = toDisplayDateFromISO(s) + " â€“ " + toDisplayDateFromISO(e);
  }

  function applyQuickRange(days) {
    const sInput = document.getElementById("assignStart");
    const eInput = document.getElementById("assignEnd");
    let s = sInput.value;
    if (!s) { const t=new Date(); s=formatDateForStore(t); sInput.value=s; }
    const [y,m,d]=s.split("-");
    const base = new Date(+y,+m-1,+d);
    const end  = new Date(base.getTime());
    end.setDate(end.getDate()+Number(days));
    eInput.value = formatDateForStore(end);
    updateAssignDatePreview();
  }

  function createAssignments() {
    const tids = getSelectedTeacherIds();
    const studs = getSelectedStudents();
    const s = document.getElementById("assignStart").value;
    const e = document.getElementById("assignEnd").value;

    if (!tids.length || !studs.length || !s || !e) { alert("LÃ¼tfen Ã¶ÄŸretmen, Ã¶ÄŸrenci ve tarih aralÄ±ÄŸÄ± seÃ§iniz."); return; }
    if (e < s) { alert("BitiÅŸ tarihi baÅŸlangÄ±Ã§tan Ã¶nce olamaz."); return; }

    let added=0;
    tids.forEach(tid=>{
      const t=teachers.find(x=>x.id===tid); if(!t) return;
      studs.forEach(st=>{
        const exists = assignments.some(a => a.teacherId===tid && assignmentStudentKey(a)===st.key && a.startDate===s && a.endDate===e);
        if (exists) return;
        assignments.push({
          id: uid(),
          teacherId: tid,
          teacherName: t.ad,
          teacherBranch: t.brans,
          studentFirstName: st.isim,
          studentLastName: st.soyisim,
          gender: st.cinsiyet,
          class: st.sinif,
          schoolNumber: st.okulNo,
          studentKey: st.key,
          parentFirstName: st.veliAdi,
          parentLastName: st.veliSoyadi,
          parentPhone: normalizePhone(st.veliTel) || st.veliTel,
          startDate: s,
          endDate: e,
          called: false,
          note: ""
        });
        added++;
      });
    });
    if (!added) alert("SeÃ§ilen kriterlere uygun yeni atama eklenemedi (zaten ekli olabilir).");
    else { 
      renderAssignmentsTable(); 
      document.getElementById("assignmentsBody").scrollIntoView({behavior: "smooth", block: "end"});
    }
  }

  function removeAssignmentById(id) {
    if(!confirm("Bu atama listeden silinsin mi?")) return;
    assignments = assignments.filter(a=>a.id!==id);
    renderAssignmentsTable();
  }

  function syncReportBackToAssignments() {
    Array.from(document.querySelectorAll(".report-called")).forEach(cb=>{
      const id = cb.getAttribute("data-assignment-id");
      const a = assignments.find(x=>x.id===id);
      if (a) a.called = cb.checked;
    });
    Array.from(document.querySelectorAll(".note-input")).forEach(t=>{
      const id = t.getAttribute("data-assignment-id");
      const a = assignments.find(x=>x.id===id);
      if (a) a.note = t.value;
    });
  }

  document.getElementById("reloadDataBtn").addEventListener("click", loadAllData);
  document.getElementById("classFilter").addEventListener("change", renderStudentsTable);
  document.getElementById("assignStart").addEventListener("change", updateAssignDatePreview);
  document.getElementById("assignEnd").addEventListener("change", updateAssignDatePreview);
  document.querySelectorAll("button[data-quick]").forEach(btn=>{
    btn.addEventListener("click", ()=>applyQuickRange(btn.getAttribute("data-quick")));
  });
  document.getElementById("selectAllStudentsBtn").addEventListener("click", ()=>{
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=true);
    document.getElementById("allRowCheckbox").checked=true;
  });
  document.getElementById("clearSelectionBtn").addEventListener("click", ()=>{
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=false);
    document.getElementById("allRowCheckbox").checked=false;
  });
  document.getElementById("allRowCheckbox").addEventListener("change",e=>{
    const c=e.target.checked;
    document.querySelectorAll(".student-checkbox").forEach(cb=>cb.checked=c);
  });
  document.getElementById("assignBtn").addEventListener("click", createAssignments);
  document.getElementById("assignmentsBody").addEventListener("click",e=>{
    const btn=e.target.closest("button[data-del-id]");
    if(btn) removeAssignmentById(btn.getAttribute("data-del-id"));
  });
  
  document.getElementById("saveAssignmentsBtn").addEventListener("click", async()=>{
    syncReportBackToAssignments();
    await saveAssignmentsToFirebase();
  });
  document.getElementById("deleteAssignmentsBtn").addEventListener("click", deleteAllAssignmentsInFirebase);
  document.getElementById("clearLocalListBtn").addEventListener("click", clearLocalList);
  
  document.getElementById("printReportsBtn").addEventListener("click", ()=>{
    syncReportBackToAssignments();
    renderReports();
    window.print();
  });

  loadAllData();
</script>
</body>
</html>
